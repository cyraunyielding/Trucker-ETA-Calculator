<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trucker ETA Calculator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer shadow */
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        .title {
            color: #2c3e50; /* Darker title color */
            font-size: 2.25rem; /* Larger title */
            font-weight: 700;
            margin-bottom: 1.75rem;
            letter-spacing: -0.025em; /* Slightly tighter letter spacing */
        }
        .input-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568; /* Medium gray for labels */
            font-size: 1rem;
        }
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #cbd5e0; /* Slightly thicker border */
            border-radius: 0.75rem; /* Rounded input fields */
            font-size: 1rem;
            color: #2d3748;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-group input:focus,
        .input-group select:focus {
            border-color: #4299e1; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* Blue glow on focus */
        }
        #calculateBtn, #toggleAdvancedBtn, #resetBtn, #toggleChainingBtn, .add-leg-btn, .remove-leg-btn { /* Added new buttons */
            background-image: linear-gradient(to right, #4299e1, #3182ce); /* Gradient button */
            color: white;
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%; /* Full width button */
            margin-top: 1rem; /* Space between buttons */
        }
        #calculateBtn:hover, #toggleAdvancedBtn:hover, #resetBtn:hover, #toggleChainingBtn:hover, .add-leg-btn:hover, .remove-leg-btn:hover { /* Added new buttons */
            background-image: linear-gradient(to right, #3182ce, #2b6cb0);
            box-shadow: 0 6px 15px rgba(66, 153, 225, 0.4);
            transform: translateY(-2px); /* Slight lift effect */
        }
        #calculateBtn:active, #toggleAdvancedBtn:active, #resetBtn:active, #toggleChainingBtn:active, .add-leg-btn:active, .remove-leg-btn:active { /* Added new buttons */
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(66, 153, 225, 0.2);
        }
        #resetBtn { /* Specific style for reset button */
            background-image: linear-gradient(to right, #e53e3e, #c53030); /* Red gradient */
            margin-top: 0.75rem; /* Slightly less margin than others */
        }
        #resetBtn:hover {
            background-image: linear-gradient(to right, #c53030, #a02020);
        }
        #toggleAdvancedBtn, #toggleChainingBtn { /* Grey buttons for toggles */
            background-image: linear-gradient(to right, #607d8b, #455a64);
        }
        #toggleAdvancedBtn:hover, #toggleChainingBtn:hover {
            background-image: linear-gradient(to right, #455a64, #37474f);
        }
        .result-area {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e0f2f7; /* Light blue background for result */
            border-radius: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c5282; /* Dark blue text */
            min-height: 50px; /* Ensure it has some height even when empty */
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word; /* Prevent long text from overflowing */
            text-align: center; /* Center the text */
        }
        .error-message {
            color: #e53e3e; /* Red for error messages */
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }
        .tip { /* Renamed from timezone-tip for general use */
            font-size: 0.85rem;
            color: #718096; /* Gray text for tips */
            margin-top: 0.5rem;
            text-align: left;
        }

        /* Advanced Options Styling */
        #advancedOptions, #chainingOptions { /* Apply to both advanced and chaining sections */
            border-top: 1px solid #e2e8f0;
            margin-top: 2rem;
            padding-top: 1.5rem;
            text-align: left;
        }
        #advancedOptions h2, #chainingOptions h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
            text-align: center;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap; /* Allow content to wrap on smaller screens */
            align-items: flex-start; /* Align items to the top for multi-line labels/tips */
            margin-bottom: 0.75rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto; /* Override full width */
            margin-right: 0.75rem;
            transform: scale(1.2); /* Slightly larger checkbox */
            cursor: pointer;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            margin-top: 0.25rem; /* Align with text baseline */
        }
        .checkbox-group label {
            margin-bottom: 0; /* Override default label margin */
            cursor: pointer;
            font-weight: 500;
            color: #4a5568;
            flex-grow: 1; /* Allow label to take available space */
        }
        .checkbox-group .tip { /* Specific styling for tips inside checkbox-group */
            width: 100%; /* Take full width below checkbox and label */
            margin-top: 0.25rem;
            margin-left: calc(1.2em + 0.75rem); /* Indent to align with label text, based on checkbox size + margin */
            font-size: 0.8rem; /* Slightly smaller for tips */
            color: #718096;
        }
        .advanced-input-group, .leg-input-group { /* For buffer percentage, 70-hour input, and leg inputs */
            margin-top: 1rem;
            margin-bottom: 1.25rem;
            text-align: left;
        }
        .advanced-input-group label, .leg-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
            font-size: 1rem;
        }
        .advanced-input-group input, .leg-input-group input, .leg-input-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #cbd5e0;
            border-radius: 0.75rem;
            font-size: 1rem;
            color: #2d3748;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .advanced-input-group input:focus, .leg-input-group input:focus, .leg-input-group select:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        .leg-section {
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc; /* Lighter background for each leg */
            position: relative; /* For remove button positioning */
        }
        .leg-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #3182ce;
            margin-bottom: 1rem;
            text-align: center;
        }
        .remove-leg-btn {
            background-image: linear-gradient(to right, #e53e3e, #c53030);
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: auto;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            box-shadow: none;
            margin-top: 0;
        }
        .remove-leg-btn:hover {
            background-image: linear-gradient(to right, #c53030, #a02020);
        }
        .add-leg-btn {
            background-image: linear-gradient(to right, #48bb78, #38a169); /* Green gradient */
        }
        .add-leg-btn:hover {
            background-image: linear-gradient(to right, #38a169, #2f855a);
        }

        #advancedResult {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #e0f7fa; /* Lighter blue for advanced result */
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #00796b; /* Teal text */
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            text-align: center;
        }

        /* Responsive adjustments for advanced section */
        @media (max-width: 640px) {
            #advancedOptions h2, #chainingOptions h2 {
                font-size: 1.25rem;
            }
            .checkbox-group {
                flex-direction: row; /* Keep checkboxes side-by-side */
                align-items: flex-start;
            }
            .checkbox-group label {
                font-size: 0.9rem;
            }
            .checkbox-group .tip {
                font-size: 0.7rem; /* Even smaller on mobile */
                margin-left: calc(1.2em + 0.75rem); /* Maintain indent */
            }
            .advanced-input-group label, .leg-input-group label {
                font-size: 0.9rem;
            }
            .advanced-input-group input, .leg-input-group input, .leg-input-group select {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
            #advancedResult {
                font-size: 1rem;
                padding: 0.8rem;
            }
            .remove-leg-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
                top: 0.75rem;
                right: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Trucker ETA Calculator</h1>

        <div class="input-group">
            <label for="miles">Total Miles (Leg 1):</label>
            <input type="number" id="miles" placeholder="e.g., 1500" class="rounded-xl">
        </div>

        <div class="input-group">
            <label for="speed">Average Speed (MPH):</label>
            <input type="number" id="speed" placeholder="e.g., 60" class="rounded-xl">
        </div>

        <div class="input-group">
            <label for="dailyDrivingLimit">Estimated Daily Driving Limit (Hours):</label>
            <select id="dailyDrivingLimit" class="rounded-xl">
                <option value="8">8 Hours</option>
                <option value="9">9 Hours</option>
                <option value="10">10 Hours</option>
                <option value="11" selected>11 Hours (Standard HOS Max)</option>
            </select>
            <p class="tip">This is your estimated maximum driving time per day. The calculator includes a 1-hour daily break (covering pre-trip, post-trip, and 30-min driving break).</p>
        </div>

        <div class="input-group">
            <label for="currentTZ">Current Time Zone (Trip Start):</label>
            <select id="currentTZ" class="rounded-xl">
                <!-- Options will be populated by JavaScript -->
            </select>
            <p class="tip">Your device's time zone is pre-selected if possible. This is the starting time zone for your entire trip.</p>
        </div>

        <div class="input-group">
            <label for="destinationTZ">Destination Time Zone (Leg 1):</label>
            <select id="destinationTZ" class="rounded-xl">
                <!-- Options will be populated by JavaScript -->
            </select>
            <p class="tip">This is the time zone for your first destination.</p>
        </div>

        <button id="calculateBtn" class="rounded-xl">Calculate ETA</button>
        <button id="resetBtn" class="rounded-xl">Reset Calculator</button>

        <div id="result" class="result-area">
            Your estimated arrival time will appear here.
        </div>

        <button id="toggleAdvancedBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
            Show Advanced HOS Options
        </button>

        <div id="advancedOptions" class="hidden">
            <h2>Advanced HOS Considerations</h2>
            <div class="checkbox-group">
                <input type="checkbox" id="apply14HourRule">
                <label for="apply14HourRule">Extend to 14-Hour On-Duty Window</label>
                <p class="tip">If checked, the calculator will assume each driving day utilizes the full 14-hour on-duty window by adding "on-duty, non-driving" time to reach 14 hours (driving + on-duty portion of daily break + additional on-duty time = 14 hours).</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="include10HourOffDuty">
                <label for="include10HourOffDuty">Include 10-Hour Off-Duty Breaks</label>
                <p class="tip">If checked, the calculator will add a 10-hour off-duty period for each night spent on the road (i.e., between each full driving day).</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="consider70HourClock">
                <label for="consider70HourClock">Consider 70-Hour Clock & 34-Hour Reset</label>
                <p class="tip">If checked, the calculator will estimate when your cumulative "on-duty" time (driving + on-duty portion of daily breaks + any additional on-duty time from 14-hour rule) would hit the 70-hour limit and add a 34-hour reset for each time this limit is crossed.</p>
            </div>
            <div class="advanced-input-group">
                <label for="current70HourClock">Current 70-Hour Clock Hours (already accumulated):</label>
                <input type="number" id="current70HourClock" placeholder="e.g., 0" class="rounded-xl">
                <p class="tip">Enter your current accumulated on-duty hours towards the 70-hour limit before this trip begins.</p>
            </div>
            <div class="advanced-input-group">
                <label for="bufferPercentage">Additional Buffer for Delays (%):</label>
                <input type="number" id="bufferPercentage" placeholder="e.g., 0" class="rounded-xl">
                <p class="tip">Add a percentage of total travel time to account for unforeseen delays (traffic, loading, etc.). Example: If your calculated travel time is 100 hours, and you add a 10% buffer, the calculator will add 10 hours to your total, making it 110 hours.</p>
            </div>
        </div>

        <button id="toggleChainingBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
            Show Destination Chaining Options
        </button>

        <div id="chainingOptions" class="hidden">
            <h2>Additional Trip Legs</h2>
            <div id="legsContainer">
                <!-- Dynamic legs (Leg 2, Leg 3, etc.) will be added here by JS -->
            </div>
            <button id="addLegBtn" class="add-leg-btn rounded-xl">Add Another Destination Leg</button>
        </div>

        <div id="advancedResult" class="result-area bg-blue-100 text-teal-800">
            Advanced ETA will appear here.
        </div>

        <div id="errorMessage" class="error-message"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Global inputs (now representing Leg 1)
            const milesInput = document.getElementById('miles'); // Now for Leg 1
            const speedInput = document.getElementById('speed');
            const dailyDrivingLimitSelect = document.getElementById('dailyDrivingLimit');
            const currentTZSelect = document.getElementById('currentTZ'); // Trip start TZ
            const destinationTZInput = document.getElementById('destinationTZ'); // Now for Leg 1

            // Buttons and sections
            const calculateBtn = document.getElementById('calculateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const toggleAdvancedBtn = document.getElementById('toggleAdvancedBtn');
            const toggleChainingBtn = document.getElementById('toggleChainingBtn');
            const advancedOptionsDiv = document.getElementById('advancedOptions');
            const chainingOptionsDiv = document.getElementById('chainingOptions');

            // Advanced HOS options
            const apply14HourRuleCheckbox = document.getElementById('apply14HourRule');
            const include10HourOffDutyCheckbox = document.getElementById('include10HourOffDuty');
            const consider70HourClockCheckbox = document.getElementById('consider70HourClock');
            const current70HourClockInput = document.getElementById('current70HourClock');
            const bufferPercentageInput = document.getElementById('bufferPercentage');

            // Results and error display
            const resultDiv = document.getElementById('result');
            const advancedResultDiv = document.getElementById('advancedResult');
            const errorMessageDiv = document.getElementById('errorMessage');

            // Chaining specific elements
            const legsContainer = document.getElementById('legsContainer');
            const addLegBtn = document.getElementById('addLegBtn');
            let legCounter = 1; // Start at 1, as the first leg is in the main section

            // Define a comprehensive list of US time zones with their IANA IDs and display names
            const timeZones = [
                { id: 'America/New_York', name: 'Eastern Time (ET)' },
                { id: 'America/Detroit', name: 'Eastern Time (ET) - Michigan' },
                { id: 'America/Indianapolis', name: 'Eastern Time (ET) - Indiana (East)' },
                { id: 'America/Chicago', name: 'Central Time (CT)' },
                { id: 'America/Menominee', name: 'Central Time (CT) - Michigan (UP)' },
                { id: 'America/North_Dakota/Center', name: 'Central Time (CT) - North Dakota' },
                { id: 'America/Denver', name: 'Mountain Time (MT)' },
                { id: 'America/Boise', name: 'Mountain Time (MT) - Idaho (South)' },
                { id: 'America/Phoenix', name: 'Arizona Time (MST) - No DST' }, // Arizona doesn't observe DST
                { id: 'America/Los_Angeles', name: 'Pacific Time (PT)' },
                { id: 'America/Anchorage', name: 'Alaska Time (AKT)' },
                { id: 'America/Adak', name: 'Hawaii-Aleutian Time (HAT)' },
                { id: 'Pacific/Honolulu', name: 'Hawaii Standard Time (HST) - No DST' }
            ];

            // Function to populate time zone dropdowns
            function populateTimeZones(selectElement) {
                timeZones.sort((a, b) => a.name.localeCompare(b.name));

                // Clear existing options before populating
                selectElement.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select time zone...';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                selectElement.appendChild(defaultOption);

                timeZones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz.id;
                    option.textContent = tz.name;
                    selectElement.appendChild(option);
                });
            }

            // Populate initial time zone dropdowns (current TZ and Leg 1 destination TZ)
            populateTimeZones(currentTZSelect);
            populateTimeZones(destinationTZInput);

            // Set user's current time zone as default for trip start
            try {
                const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const matchingTZ = timeZones.find(tz => tz.id === userTimeZone);
                if (matchingTZ) {
                    currentTZSelect.value = userTimeZone;
                } else {
                    currentTZSelect.value = '';
                }
            } catch (e) {
                console.error("Could not determine user's time zone:", e);
                currentTZSelect.value = '';
            }

            // Function to add a new leg
            function addLeg() {
                legCounter++; // This will make it Leg 2, Leg 3, etc.
                const newLegHtml = `
                    <div class="leg-section" id="leg-${legCounter}">
                        <h3>Leg ${legCounter}: Destination ${legCounter - 1} to Destination ${legCounter}</h3>
                        <button type="button" class="remove-leg-btn rounded-xl" data-leg-id="${legCounter}">Remove</button>
                        <div class="leg-input-group">
                            <label for="miles-${legCounter}">Miles for Leg ${legCounter}:</label>
                            <input type="number" id="miles-${legCounter}" placeholder="e.g., 500" class="rounded-xl">
                        </div>
                        <div class="leg-input-group">
                            <label for="destinationTZ-${legCounter}">Destination Time Zone for Leg ${legCounter}:</label>
                            <select id="destinationTZ-${legCounter}" class="rounded-xl">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>
                `;
                legsContainer.insertAdjacentHTML('beforeend', newLegHtml);

                // Populate time zones for the new leg's destination
                const newDestinationTZSelect = document.getElementById(`destinationTZ-${legCounter}`);
                populateTimeZones(newDestinationTZSelect);

                // Add event listeners to new inputs for recalculation
                document.getElementById(`miles-${legCounter}`).addEventListener('input', calculateETA);
                newDestinationTZSelect.addEventListener('change', calculateETA);
                document.querySelector(`#leg-${legCounter} .remove-leg-btn`).addEventListener('click', removeLeg);

                calculateETA(); // Recalculate after adding a leg
            }

            // Function to remove a leg
            function removeLeg(event) {
                const legIdToRemove = event.target.dataset.legId;
                const legElement = document.getElementById(`leg-${legIdToRemove}`);
                if (legElement) {
                    legElement.remove();
                    // No need to decrement legCounter or re-index IDs for now,
                    // as we iterate through existing sections.
                    calculateETA();
                }
            }

            // Function to perform the ETA calculation
            function calculateETA() {
                errorMessageDiv.textContent = '';
                resultDiv.textContent = 'Calculating...';
                advancedResultDiv.textContent = 'Advanced ETA will appear here.';

                const avgSpeed = parseFloat(speedInput.value);
                const dailyDriveLimit = parseFloat(dailyDrivingLimitSelect.value);
                let current70HrClock = parseFloat(current70HourClockInput.value);
                let bufferPct = parseFloat(bufferPercentageInput.value);

                // Input validation for global fields
                if (isNaN(avgSpeed) || avgSpeed <= 0) {
                    errorMessageDiv.textContent = 'Please enter a valid positive number for average speed.';
                    return;
                }
                if (isNaN(dailyDriveLimit) || dailyDriveLimit <= 0) {
                    errorMessageDiv.textContent = 'Please select a valid daily driving limit.';
                    return;
                }
                if (!currentTZSelect.value) {
                    errorMessageDiv.textContent = 'Please select your current time zone (Trip Start).';
                    return;
                }
                // Default NaN to 0 for calculations
                if (isNaN(current70HrClock) || current70HrClock < 0) {
                    current70HrClock = 0;
                }
                if (isNaN(bufferPct) || bufferPct < 0) {
                    bufferPct = 0;
                }

                let totalTripHours = 0;
                let cumulativeOnDutyTimeFor70Clock = current70HrClock;
                let currentLegOriginTZ = currentTZSelect.value; // Origin for the first leg

                const dailyBreakTotal = 1; // 0.5 on-duty, 0.5 off-duty
                const dailyBreakOnDutyPortion = 0.5;
                const dailyBreakOffDutyPortion = 0.5;

                const allLegsData = [];

                // --- Process Leg 1 (from main section) ---
                const leg1Miles = parseFloat(milesInput.value);
                const leg1DestinationTZ = destinationTZInput.value;

                if (isNaN(leg1Miles) || leg1Miles <= 0) {
                    errorMessageDiv.textContent = 'Please enter valid positive miles for Leg 1.';
                    return;
                }
                if (!leg1DestinationTZ) {
                    errorMessageDiv.textContent = 'Please select a destination time zone for Leg 1.';
                    return;
                }
                allLegsData.push({ miles: leg1Miles, destTZ: leg1DestinationTZ });

                // --- Process dynamically added legs ---
                const dynamicLegSections = legsContainer.querySelectorAll('.leg-section');
                dynamicLegSections.forEach((legElement, index) => {
                    const legNumber = index + 2; // Start from Leg 2
                    const miles = parseFloat(legElement.querySelector(`#miles-${legNumber}`).value);
                    const destTZ = legElement.querySelector(`#destinationTZ-${legNumber}`).value;

                    if (isNaN(miles) || miles <= 0) {
                        errorMessageDiv.textContent = `Please enter valid positive miles for Leg ${legNumber}.`;
                        allLegsData.length = 0; // Invalidate all legs
                        return;
                    }
                    if (!destTZ) {
                        errorMessageDiv.textContent = `Please select a destination time zone for Leg ${legNumber}.`;
                        allLegsData.length = 0; // Invalidate all legs
                        return;
                    }
                    allLegsData.push({ miles: miles, destTZ: destTZ });
                });

                if (allLegsData.length === 0) { // If any validation failed, allLegsData might be empty
                    resultDiv.textContent = 'Your estimated arrival time will appear here.';
                    advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                    return;
                }

                const legSummaries = [];
                let currentTotalTripHours = 0; // This accumulates across legs for the final ETA
                let currentCumulativeOnDutyTimeFor70Clock = cumulativeOnDutyTimeFor70Clock; // This accumulates for 70-hr clock

                allLegsData.forEach((legData, index) => {
                    const legNumber = index + 1;
                    const legMiles = legData.miles;
                    const legDestinationTZ = legData.destTZ;

                    const legDrivingHours = legMiles / avgSpeed;
                    const numDrivingDaysForLeg = legDrivingHours > 0 ? Math.ceil(legDrivingHours / dailyDriveLimit) : 0;

                    let legHoursAddedToTotalTrip = legDrivingHours; // Time added to total trip duration for this leg
                    let legOnDutyHoursFor70Clock = legDrivingHours; // On-duty hours for this leg for 70-clock

                    // Add daily off-duty break portion to total leg hours (always part of total trip time)
                    legHoursAddedToTotalTrip += (numDrivingDaysForLeg * dailyBreakOffDutyPortion);

                    // Add daily on-duty break portion to 70-hour clock for this leg (always counts towards 70)
                    legOnDutyHoursFor70Clock += (numDrivingDaysForLeg * dailyBreakOnDutyPortion);

                    // Apply "Extend to 14-Hour On-Duty Window" rule
                    if (apply14HourRuleCheckbox.checked) {
                        const currentOnDutyPerDrivingDay = dailyDriveLimit + dailyBreakOnDutyPortion;
                        if (currentOnDutyPerDrivingDay < 14) {
                            const additionalOnDutyNonDrivingPerDay = 14 - currentOnDutyPerDrivingDay;
                            legHoursAddedToTotalTrip += numDrivingDaysForLeg * additionalOnDutyNonDrivingPerDay;
                            legOnDutyHoursFor70Clock += numDrivingDaysForLeg * additionalOnDutyNonDrivingPerDay;
                        }
                    }

                    // Add 10-Hour Off-Duty Breaks (between driving days within this leg)
                    if (include10HourOffDutyCheckbox.checked) {
                        const numOvernightBreaksForLeg = numDrivingDaysForLeg > 1 ? (numDrivingDaysForLeg - 1) : 0;
                        legHoursAddedToTotalTrip += numOvernightBreaksForLeg * 10;
                    }

                    // Update cumulative 70-hour clock with on-duty hours from this leg
                    currentCumulativeOnDutyTimeFor70Clock += legOnDutyHoursFor70Clock;

                    // Consider 70-Hour Clock & 34-Hour Reset (applied cumulatively across legs)
                    if (consider70HourClockCheckbox.checked) {
                        const num70HourBlocks = Math.floor(currentCumulativeOnDutyTimeFor70Clock / 70);
                        if (num70HourBlocks > 0) {
                            legHoursAddedToTotalTrip += num70HourBlocks * 34; // Add 34-hour reset time to this leg's total
                            currentCumulativeOnDutyTimeFor70Clock -= (num70HourBlocks * 70); // Reset 70-hour clock for next segment
                        }
                    }

                    currentTotalTripHours += legHoursAddedToTotalTrip;

                    // Calculate arrival time for this specific leg's destination
                    const tripStartTime = new Date(); // Reference for the entire trip
                    const legArrivalTimeMs = tripStartTime.getTime() + (currentTotalTripHours * 60 * 60 * 1000);
                    const legArrivalDate = new Date(legArrivalTimeMs);

                    const legFormatter = new Intl.DateTimeFormat('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: 'numeric', minute: 'numeric', timeZoneName: 'short',
                        timeZone: legDestinationTZ, // Convert to this leg's destination TZ
                        hour12: true
                    });
                    const formattedLegArrival = legFormatter.format(legArrivalDate);

                    legSummaries.push(`Leg ${legNumber} (to ${legDestinationTZ}): Arrives ${formattedLegArrival}`);

                    // The currentLegOriginTZ is implicitly handled by using the previous leg's destTZ for the next leg's calculation
                });


                // Apply Additional Buffer for Delays to the *final* total trip hours
                if (bufferPct > 0) {
                    currentTotalTripHours *= (1 + bufferPct / 100);
                }

                const tripStartTime = new Date(); // Re-get current time for final calculation
                const finalArrivalTimeMs = tripStartTime.getTime() + (currentTotalTripHours * 60 * 60 * 1000);
                const finalArrivalDate = new Date(finalArrivalTimeMs);
                const finalFormatter = new Intl.DateTimeFormat('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: 'numeric', minute: 'numeric', timeZoneName: 'short',
                    timeZone: allLegsData[allLegsData.length - 1].destTZ, // Final destination TZ of the last leg
                    hour12: true
                });
                const formattedFinalArrival = finalFormatter.format(finalArrivalDate);

                // Display results
                resultDiv.textContent = `Estimated Total Trip Arrival: ${formattedFinalArrival}`;
                advancedResultDiv.innerHTML = `<h3>Trip Summary:</h3>` + legSummaries.join('<br>') + `<br><br><strong>Overall Estimated Arrival: ${formattedFinalArrival}</strong>`;
            }

            // Function to reset all inputs and results
            function resetCalculator() {
                milesInput.value = ''; // Reset Leg 1 miles
                speedInput.value = '';
                dailyDrivingLimitSelect.value = '11'; // Reset to default 11 hours
                populateTimeZones(currentTZSelect); // Re-populate current time zone
                populateTimeZones(destinationTZInput); // Re-populate Leg 1 destination TZ
                current70HourClockInput.value = ''; // Clear to show placeholder
                bufferPercentageInput.value = ''; // Clear to show placeholder
                apply14HourRuleCheckbox.checked = false;
                include10HourOffDutyCheckbox.checked = false;
                consider70HourClockCheckbox.checked = false;
                resultDiv.textContent = 'Your estimated arrival time will appear here.';
                advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                errorMessageDiv.textContent = '';

                // Clear all dynamically added legs
                legsContainer.innerHTML = '';
                legCounter = 1; // Reset leg counter for next additions

                // Hide advanced and chaining options by default on reset
                advancedOptionsDiv.classList.add('hidden');
                toggleAdvancedBtn.textContent = 'Show Advanced HOS Options';
                chainingOptionsDiv.classList.add('hidden');
                toggleChainingBtn.textContent = 'Show Destination Chaining Options';

                calculateETA(); // Recalculate after reset
            }


            // Event Listeners for global inputs (Leg 1)
            milesInput.addEventListener('input', calculateETA);
            speedInput.addEventListener('input', calculateETA);
            dailyDrivingLimitSelect.addEventListener('change', calculateETA);
            currentTZSelect.addEventListener('change', calculateETA);
            destinationTZInput.addEventListener('change', calculateETA); // For Leg 1

            // Event Listeners for buttons
            calculateBtn.addEventListener('click', calculateETA);
            resetBtn.addEventListener('click', resetCalculator);

            // Event Listeners for toggles
            toggleAdvancedBtn.addEventListener('click', () => {
                advancedOptionsDiv.classList.toggle('hidden');
                advancedOptionsDiv.classList.toggle('block');
                calculateETA(); // Recalculate when visibility changes
            });

            toggleChainingBtn.addEventListener('click', () => {
                chainingOptionsDiv.classList.toggle('hidden');
                chainingOptionsDiv.classList.toggle('block');
                if (chainingOptionsDiv.classList.contains('block')) {
                    toggleChainingBtn.textContent = 'Hide Destination Chaining Options';
                } else {
                    toggleChainingBtn.textContent = 'Show Destination Chaining Options';
                }
                calculateETA(); // Recalculate when visibility changes
            });

            // Event Listeners for dynamic leg management
            addLegBtn.addEventListener('click', addLeg);
            legsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-leg-btn')) {
                    removeLeg(event);
                }
            });

            // Event listeners for advanced HOS options
            apply14HourRuleCheckbox.addEventListener('change', calculateETA);
            include10HourOffDutyCheckbox.addEventListener('change', calculateETA);
            consider70HourClockCheckbox.addEventListener('change', calculateETA);
            current70HourClockInput.addEventListener('input', calculateETA);
            bufferPercentageInput.addEventListener('input', calculateETA);

            // Initial calculation when page loads
            calculateETA();
        });
    </script>
</body>
</html>
