<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruckerPro ETA Calculator</title>
    <!-- theBacchanalian -->
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, deleteDoc, getDocs, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - EMBEDDED HERE
        const firebaseConfig = {
            apiKey: "AIzaSyA8_guHEaQwhFaSziqPMQIKVHdk4A0LSPA",
            authDomain: "truckerpro-15e99.firebaseapp.com",
            projectId: "truckerpro-15e99",
            storageBucket: "truckerpro-15e99.firebaseapp.com",
            messagingSenderId: "44586799726",
            appId: "1:44586799726:web:e32b82837133b128dc8c7f",
            measurementId: "G-8NK9D8H849"
        };

        // Define a fixed app ID for Firestore path since we are not in Canvas environment
        const appId = 'trucker-eta-calculator-app'; // This will be used in your Firestore paths

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // Will store the authenticated user's ID
        let isAuthReady = false; // Flag to indicate if authentication is complete

        <!-- theBacchanalian -->
        // IMPORTANT: Replace 'YOUR_ADMIN_FIREBASE_UID_HERE' with your actual Firebase User ID (UID).
        // You can find your UID by inspecting the console after signing in anonymously to your deployed app,
        // or by checking the Firebase Authentication section in your project.
        // Example: const ADMIN_UID = 'someLongRandomStringFromFirebase';
        const ADMIN_UID = 'YOUR_ADMIN_FIREBASE_UID_HERE'; // <--- REPLACE THIS WITH YOUR ACTUAL UID FOR ADMIN ACCESS

        // Authenticate user and set up auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Firebase authenticated. User ID:", userId);
                isAuthReady = true;
                // Load logs for the current date after authentication
                loadLogsForSelectedDate();
                // If linking is enabled, update HOS from logs immediately
                if (document.getElementById('linkLogsToCalculator').checked) {
                    updateHOSFromLogs();
                }
                // Start listening for comments once authenticated
                listenForComments(); // This will now also load hidden comments
                // Start listening for announcements once authenticated
                listenForAnnouncements(); // New: Listen for announcements
            } else {
                // Sign in anonymously if no user is authenticated
                try {
                    await signInAnonymously(auth);
                    // After anonymous sign-in, userId will be set by the onAuthStateChanged listener
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    document.getElementById('errorMessage').textContent = "Authentication failed. Log sheet and comment features may not work.";
                }
            }
        });

        // Make Firebase instances and userId globally accessible in the script
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.getFirebaseUserId = () => userId; // Function to get userId
        window.getIsAuthReady = () => isAuthReady; // Function to check auth readiness
        window.appId = appId; // Make appId available globally for Firestore paths
        window.getAdminUID = () => ADMIN_UID; // Make ADMIN_UID accessible for comment deletion logic
    </script>
    <!-- PayPal SDK Script (Code 1) -->
    <script
      src="https://www.paypal.com/sdk/js?client-id=BAACbOyrXuyfxCVaTr03e67fOFNuqQR69H2k8gpGnRc9r3WseW2narbSNIBVLh3uk5JY2dU6S6w8Wwk_UM&components=hosted-buttons&enable-funding=venmo&currency=USD">
    </script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer shadow */
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        .title-group {
            margin-bottom: 1.75rem;
        }
        .main-title {
            color: #2c3e50; /* Darker title color */
            font-size: 2.75rem; /* Larger title */
            font-weight: 800; /* Extra bold */
            margin-bottom: 0.25rem; /* Small space between titles */
            letter-spacing: -0.05em; /* Tighter letter spacing */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .sub-title {
            color: #607d8b; /* Muted gray for subtitle */
            font-size: 1.5rem; /* Subdued size */
            font-weight: 500; /* Medium weight */
            margin-top: 0;
        }
        .input-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568; /* Medium gray for labels */
            font-size: 1rem;
        }
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #cbd5e0; /* Slightly thicker border */
            border-radius: 0.75rem; /* Rounded input fields */
            font-size: 1rem;
            color: #2d3748;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-group input:focus,
        .input-group select:focus {
            border-color: #4299e1; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* Blue glow on focus */
        }
        .input-group input[readonly],
        .input-group select[readonly] {
            background-color: #e9ecef; /* Light gray for read-only fields */
            cursor: not-allowed;
            border-color: #ced4da;
        }
        #calculateBtn, #toggleAdvancedBtn, #resetBtn, #toggleChainingBtn, #toggleLogSheetBtn, .add-leg-btn, .remove-leg-btn, #addLogEntryBtn, .edit-log-btn, .delete-log-btn, #updateLocationBtn, #showCommentsBtn, #submitCommentBtn, .hide-comment-btn, #toggleAnnouncementsBtn, #saveAnnouncementBtn { /* Added new buttons, including updateLocationBtn */
            background-image: linear-gradient(to right, #4299e1, #3182ce); /* Gradient button */
            color: white;
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%; /* Full width button */
            margin-top: 1rem; /* Space between buttons */
        }
        #calculateBtn:hover, #toggleAdvancedBtn:hover, #resetBtn:hover, #toggleChainingBtn:hover, #toggleLogSheetBtn:hover, .add-leg-btn:hover, .remove-leg-btn:hover, #addLogEntryBtn:hover, .edit-log-btn:hover, .delete-log-btn:hover, #updateLocationBtn:hover, #showCommentsBtn:hover, #submitCommentBtn:hover, .hide-comment-btn:hover, #toggleAnnouncementsBtn:hover, #saveAnnouncementBtn:hover { /* Added new buttons */
            background-image: linear-gradient(to right, #3182ce, #2b6cb0);
            box-shadow: 0 6px 15px rgba(66, 153, 225, 0.4);
            transform: translateY(-2px); /* Slight lift effect */
        }
        #calculateBtn:active, #toggleAdvancedBtn:active, #resetBtn:active, #toggleChainingBtn:active, #toggleLogSheetBtn:active, .add-leg-btn:active, .remove-leg-btn:active, #addLogEntryBtn:active, .edit-log-btn:active, .delete-log-btn:active, #updateLocationBtn:active, #showCommentsBtn:active, #submitCommentBtn:active, .hide-comment-btn:active, #toggleAnnouncementsBtn:active, #saveAnnouncementBtn:active { /* Added new buttons */
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(66, 153, 225, 0.2);
        }
        #resetBtn, .delete-log-btn { /* Specific style for reset and delete buttons */
            background-image: linear-gradient(to right, #e53e3e, #c53030); /* Red gradient */
            margin-top: 0.75rem; /* Slightly less margin than others */
        }
        #resetBtn:hover, .delete-log-btn:hover {
            background-image: linear-gradient(to right, #c53030, #a02020);
        }
        #toggleAdvancedBtn, #toggleChainingBtn, #toggleLogSheetBtn, #showCommentsBtn, #toggleAnnouncementsBtn { /* Grey buttons for toggles */
            background-image: linear-gradient(to right, #607d8b, #455a64);
        }
        #toggleAdvancedBtn:hover, #toggleChainingBtn:hover, #toggleLogSheetBtn:hover, #showCommentsBtn:hover, #toggleAnnouncementsBtn:hover {
            background-image: linear-gradient(to right, #455a64, #37474f);
        }
        .result-area {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e0f2f7; /* Light blue background for result */
            border-radius: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c5282; /* Dark blue text */
            min-height: 50px; /* Ensure it has some height even when empty */
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word; /* Prevent long text from overflowing */
            text-align: center; /* Center the text */
        }
        .error-message {
            color: #e53e3e; /* Red for error messages */
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }
        .tip { /* Renamed from timezone-tip for general use */
            font-size: 0.85rem;
            color: #718096; /* Gray text for tips */
            margin-top: 0.5rem;
            text-align: left;
        }

        /* Collapsible Section Styling (Advanced, Chaining, Log Sheet, Comments, Announcements) */
        #advancedOptions, #chainingOptions, #logSheetSection, #commentsSectionContent, #announcementsSectionContent {
            border-top: 1px solid #e2e8f0;
            margin-top: 2rem;
            padding-top: 1.5rem;
            text-align: left;
        }
        #advancedOptions h2, #chainingOptions h2, #logSheetSection h2, #commentsSectionContent h2, #announcementsSectionContent h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
            text-align: center;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap; /* Allow content to wrap on smaller screens */
            align-items: flex-start; /* Align items to the top for multi-line labels/tips */
            margin-bottom: 0.75rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto; /* Override full width */
            margin-right: 0.75rem;
            transform: scale(1.2); /* Slightly larger checkbox */
            cursor: pointer;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            margin-top: 0.25rem; /* Align with text baseline */
        }
        .checkbox-group label {
            margin-bottom: 0; /* Override default label margin */
            cursor: pointer;
            font-weight: 500;
            color: #4a5568;
            flex-grow: 1; /* Allow label to take available space */
        }
        .checkbox-group .tip { /* Specific styling for tips inside checkbox-group */
            width: 100%; /* Take full width below checkbox and label */
            margin-top: 0.25rem;
            margin-left: calc(1.2em + 0.75rem); /* Indent to align with label text, based on checkbox size + margin */
            font-size: 0.8rem; /* Slightly smaller for tips */
            color: #718096;
        }
        .advanced-input-group, .leg-input-group, .log-input-group, .comment-input-group, .announcement-input-group { /* Added announcement-input-group */
            margin-top: 1rem;
            margin-bottom: 1.25rem;
            text-align: left;
        }
        .advanced-input-group label, .leg-input-group label, .log-input-group label, .comment-input-group label, .announcement-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
            font-size: 1rem;
        }
        .advanced-input-group input, .leg-input-group input, .leg-input-group select, .log-input-group input, .log-input-group select, .log-input-group textarea, .comment-input-group textarea, .announcement-input-group textarea { /* Added announcement-input-group textarea */
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #cbd5e0;
            border-radius: 0.75rem;
            font-size: 1rem;
            color: #2d3748;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .advanced-input-group input:focus, .leg-input-group input:focus, .leg-input-group select:focus, .log-input-group input:focus, .log-input-group select:focus, .log-input-group textarea:focus, .comment-input-group textarea:focus, .announcement-input-group textarea:focus { /* Added announcement-input-group textarea */
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        .leg-section {
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc; /* Lighter background for each leg */
            position: relative; /* For remove button positioning */
        }
        .leg-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #3182ce;
            margin-bottom: 1rem;
            text-align: center;
        }
        .remove-leg-btn {
            background-image: linear-gradient(to right, #e53e3e, #c53030);
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: auto;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            box-shadow: none;
            margin-top: 0;
        }
        .remove-leg-btn:hover {
            background-image: linear-gradient(to right, #c53030, #a02020);
        }
        .add-leg-btn {
            background-image: linear-gradient(to right, #48bb78, #38a169); /* Green gradient */
        }
        .add-leg-btn:hover {
            background-image: linear-gradient(to right, #38a169, #2f855a);
        }

        #advancedResult {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #e0f7fa; /* Lighter blue for advanced result */
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #00796b; /* Teal text */
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            text-align: center;
        }

        .footer-content {
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
            font-size: 0.85rem;
            color: #718096;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        .footer-content a {
            color: #4299e1;
            text-decoration: none;
            font-weight: 500;
        }
        .footer-content a:hover {
            text-decoration: underline;
        }
        .qr-code-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .qr-code-container img {
            width: 100px;
            height: 100px;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            padding: 5px;
            background-color: white;
        }
        .qr-code-container p {
            font-size: 0.75rem;
            color: #718096;
        }
        .logo-container {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: center;
        }
        .logo-container img {
            max-width: 150px;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            background-color: #f0f4f8; /* Light background for logo */
            padding: 10px;
        }

        /* Log Sheet Specific Styles */
        #logSheetSection {
            border-top: 1px solid #e2e8f0;
            margin-top: 2rem;
            padding-top: 1.5rem;
            text-align: left;
        }
        #logSheetSection h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
            text-align: center;
        }
        .disclaimer-note {
            background-color: #fff3cd; /* Light yellow for warning */
            border: 1px solid #ffeeba;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #856404; /* Darker yellow text */
            text-align: center;
        }
        .log-form {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        .log-table-container {
            overflow-x: auto; /* Allows horizontal scrolling on small screens */
            margin-top: 1.5rem;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .log-table th, .log-table td {
            border: 1px solid #cbd5e0;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.9rem;
        }
        .log-table th {
            background-color: #edf2f7;
            font-weight: 600;
            color: #4a5568;
        }
        .log-table tr:nth-child(even) {
            background-color: #f7fafc;
        }
        .log-table tr:hover {
            background-color: #ebf8ff;
        }
        .log-table td:last-child { /* Actions column */
            white-space: nowrap; /* Prevent buttons from wrapping */
        }
        .log-table .edit-log-btn, .log-table .delete-log-btn {
            width: auto;
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            margin: 0.2rem;
            box-shadow: none;
            display: inline-block; /* Allow them to sit side-by-side */
        }
        .log-summary {
            background-color: #e0f7fa;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            border: 1px solid #b2ebf2;
            color: #00796b;
            font-weight: 600;
            text-align: left;
        }
        .log-summary p {
            margin-bottom: 0.5rem;
        }
        .log-summary p:last-child {
            margin-bottom: 0;
        }
        .log-summary strong {
            color: #004d40;
        }
        .location-display {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #4a5568;
            text-align: left;
            min-height: 1.5rem; /* Ensure space even when empty */
        }

        /* Responsive adjustments for advanced section */
        @media (max-width: 640px) {
            #advancedOptions h2, #chainingOptions h2, #logSheetSection h2, #commentsSectionContent h2, #announcementsSectionContent h2 {
                font-size: 1.25rem;
            }
            .checkbox-group {
                flex-direction: row; /* Keep checkboxes side-by-side */
                align-items: flex-start;
            }
            .checkbox-group label {
                font-size: 0.9rem;
            }
            .checkbox-group .tip {
                font-size: 0.7rem; /* Even smaller on mobile */
                margin-left: calc(1.2em + 0.75rem); /* Maintain indent */
            }
            .advanced-input-group label, .leg-input-group label, .log-input-group label, .comment-input-group label, .announcement-input-group label {
                font-size: 0.9rem;
            }
            .advanced-input-group input, .leg-input-group input, .leg-input-group select, .log-input-group input, .log-input-group select, .log-input-group textarea, .comment-input-group textarea, .announcement-input-group textarea {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
            #advancedResult {
                font-size: 1rem;
                padding: 0.8rem;
            }
            .remove-leg-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
                top: 0.75rem;
                right: 0.75rem;
            }
            .logo-container img {
                max-width: 120px;
            }
            .footer-content {
                font-size: 0.75rem;
            }
            .qr-code-container img {
                width: 80px;
                height: 80px;
            }
            .log-table th, .log-table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            .log-table .edit-log-btn, .log-table .delete-log-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            .disclaimer-note {
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
            }
        }

        /* Comments Section Specific Styles (formerly modal, now inline) */
        .comments-display-area, .announcements-display-area { /* Applied to both comments and announcements */
            border-top: 1px solid #e2e8f0;
            padding-top: 1rem;
            margin-top: 1rem;
            max-height: 300px; /* Max height for comment list */
            overflow-y: auto; /* Scroll for comments */
            display: flex; /* Changed to flex for better internal layout */
            flex-direction: column;
            gap: 0.75rem; /* Space between comments */
        }

        .comment-entry, .announcement-entry { /* Applied to both comments and announcements */
            background-color: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: left;
            display: flex;
            flex-direction: column;
            position: relative; /* For delete/hide button positioning */
        }

        .comment-entry strong, .announcement-entry strong {
            color: #3182ce;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.25rem;
            word-break: break-all; /* Ensure long IDs wrap */
        }

        .comment-entry .timestamp, .announcement-entry .timestamp {
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 0.5rem;
            display: block;
        }

        .comment-entry p, .announcement-entry p {
            font-size: 0.9rem;
            color: #4a5568;
            line-height: 1.4;
        }

        .comment-entry .delete-comment-btn, .announcement-entry .delete-announcement-btn { /* Added announcement delete button */
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #e53e3e;
            color: white;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            font-size: 0.75rem; /* text-xs */
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .comment-entry .delete-comment-btn:hover, .announcement-entry .delete-announcement-btn:hover {
            background-color: #c53030;
        }

        .comment-entry .hide-comment-btn {
            position: absolute;
            top: 0.5rem;
            right: 4.5rem; /* Positioned next to delete button */
            background-color: #607d8b; /* Gray color */
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .comment-entry .hide-comment-btn:hover {
            background-color: #455a64;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- theBacchanalian -->
        <div class="logo-container">
            <img id="truckLogo" src="YOUR_TRUCK_LOGO_IMAGE_URL_HERE" alt="Trucker ETA Logo">
        </div>
        <div class="title-group">
            <h1 class="main-title">TruckerPro</h1>
            <h2 class="sub-title">ETA Calculator</h2>
        </div>

        <div class="input-group">
            <label for="miles">Total Miles (Leg 1):</label>
            <input type="number" id="miles" placeholder="e.g., 1500" class="rounded-xl">
        </div>

        <div class="input-group">
            <label for="speed">Average Speed (MPH):</label>
            <input type="number" id="speed" placeholder="e.g., 60" class="rounded-xl">
        </div>

        <div class="input-group">
            <label for="dailyDrivingLimit">Estimated Daily Driving Limit (Hours):</label>
            <select id="dailyDrivingLimit" class="rounded-xl">
                <option value="8">8 Hours</option>
                <option value="9">9 Hours</option>
                <option value="10">10 Hours</option>
                <option value="11" selected>11 Hours (Standard HOS Max)</option>
            </select>
            <p class="tip">This is your estimated maximum driving time per day.</p>
        </div>

        <div class="input-group">
            <label for="currentTZ">Current Time Zone (Trip Start):</label>
            <select id="currentTZ" class="rounded-xl">
                <!-- Options will be populated by JavaScript -->
            </select>
            <p class="tip">Your device's time zone is pre-selected if possible. This is the starting time zone for your entire trip. Lat/Long input will override this selection.</p>
            <div class="checkbox-group mt-2"> <!-- Added mt-2 for spacing -->
                <input type="checkbox" id="showManualCurrentLatLon">
                <label for="showManualCurrentLatLon" class="text-sm font-normal">Lat/Long</label>
            </div>
        </div>

        <!-- Manual Current Location Lat/Lon Inputs (hidden by default) -->
        <div id="manualCurrentLatLonOptions" class="hidden">
            <div class="input-group">
                <label for="currentLat">Current Latitude (for planning):</label>
                <input type="number" id="currentLat" placeholder="e.g., 34.0522" step="0.000001" class="rounded-xl">
            </div>
            <div class="input-group">
                <label for="currentLon">Current Longitude (for planning):</label>
                <input type="number" id="currentLon" placeholder="e.g., -118.2437" step="0.000001" class="rounded-xl">
            </div>
            <div id="currentInferredTZDisplay" class="location-display text-center"></div>
            <p class="tip">Time zone for trip start will be inferred from these coordinates.</p>
        </div>
        <!-- End Manual Current Location Lat/Lon Inputs -->

        <!-- Always visible GPS Current Location -->
        <button id="updateLocationBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
            Update Current Location (GPS)
        </button>
        <div id="currentLocationDisplay" class="location-display"></div>
        <p class="tip">
            This button provides your *actual* current Latitude and Longitude. It does not influence the calculator's logic and your location data is not stored or shared.
        </p>
        <!-- End Always visible GPS Current Location -->


        <div class="input-group">
            <label for="destinationTZ">Destination Time Zone (Leg 1):</label>
            <select id="destinationTZ" class="rounded-xl">
                <!-- Options will be populated by JavaScript -->
            </select>
            <p class="tip">The time zone of your first destination. Lat/Long input will override this selection.</p>
            <div class="checkbox-group mt-2"> <!-- Added mt-2 for spacing -->
                <input type="checkbox" id="showDestLatLon1">
                <label for="showDestLatLon1" class="text-sm font-normal">Lat/Long</label>
            </div>
        </div>

        <!-- Leg 1 Destination Lat/Lon Inputs (hidden by default) -->
        <div id="leg1DestLatLonOptions" class="hidden">
            <div class="input-group">
                <label for="destinationLat">Destination Latitude (Leg 1):</label>
                <input type="number" id="destinationLat" placeholder="e.g., 34.0522" step="0.000001" class="rounded-xl">
            </div>
            <div class="input-group">
                <label for="destinationLon">Destination Longitude (Leg 1):</label>
                <input type="number" id="destinationLon" placeholder="e.g., -118.2437" step="0.000001" class="rounded-xl">
            </div>
            <div id="leg1DestinationTZDisplay" class="location-display text-center"></div>
            <p class="tip">Time zone will be inferred from these coordinates.</p>
        </div>
        <!-- End Leg 1 Destination Lat/Lon Inputs -->
        <!-- theBacchanalian -->

        <button id="calculateBtn" class="rounded-xl">Calculate ETA</button>
        <button id="resetBtn" class="rounded-xl">Reset Calculator</button>

        <div id="result" class="result-area">
            Your estimated arrival time will appear here.
        </div>

        <button id="toggleAdvancedBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
            Show Advanced HOS Options
        </button>

        <div id="advancedOptions" class="hidden">
            <h2>Advanced HOS Considerations</h2>
            <div class="input-group">
                <label for="plannedDailyBreakTotal">Planned Daily Break (Total Hours):</label>
                <input type="number" id="plannedDailyBreakTotal" value="1" step="0.1" placeholder="e.g., 1.0" class="rounded-xl">
                <p class="tip">Total hours planned for daily breaks (e.g., pre-trip, post-trip, 30-min driving break, fueling, etc.). Default is 1 hour.</p>
            </div>
            <div class="input-group">
                <label for="onDutyPortionOfDailyBreak">On-Duty Portion of Daily Break (Hours):</label>
                <input type="number" id="onDutyPortionOfDailyBreak" value="0.5" step="0.1" placeholder="e.g., 0.5" class="rounded-xl">
                <p class="tip">Portion of your daily break that counts as "on-duty, non-driving" time (e.g., pre-trip, post-trip inspections). Default is 0.5 hours.</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="apply14HourRule">
                <label for="apply14HourRule">Extend to 14-Hour On-Duty Window</label>
                <p class="tip">If checked, the calculator will assume each driving day utilizes the full 14-hour on-duty window by adding "on-duty, non-driving" time to reach 14 hours (driving + on-duty portion of daily break + additional on-duty time = 14 hours).</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="include10HourOffDuty">
                <label for="include10HourOffDuty">Include 10-Hour Off-Duty Breaks</label>
                <p class="tip">If checked, the calculator will add a 10-hour off-duty period for each night spent on the road (i.e., between each full driving day).</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="consider70HourClock">
                <label for="consider70HourClock">Consider 70-Hour Clock & 34-Hour Reset</label>
                <p class="tip">If checked, the calculator will estimate when your cumulative "on-duty" time (driving + on-duty portion of daily breaks + any additional on-duty time from 14-hour rule) would hit the 70-hour limit and add a 34-hour reset for each time this limit is crossed.</p>
            </div>
            <div class="advanced-input-group">
                <label for="current70HourClock">Current 70-Hour Clock Hours (already accumulated):</label>
                <input type="number" id="current70HourClock" placeholder="e.g., 0" class="rounded-xl">
                <p class="tip">Enter your current accumulated on-duty hours towards the 70-hour limit before this trip begins.</p>
            </div>
            <div class="advanced-input-group">
                <label for="bufferPercentage">Additional Buffer for Delays (%):</label>
                <input type="number" id="bufferPercentage" placeholder="e.g., 0" class="rounded-xl">
                <p class="tip">Add a percentage of total travel time to account for unforeseen delays (traffic, loading, etc.). Example: If your calculated travel time is 100 hours, and you add a 10% buffer, the calculator will add 10 hours to your total, making it 110 hours.</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableRoundTrip">
                <label for="enableRoundTrip">Enable Round Trip</label>
                <p class="tip">If checked, the calculator will add a return leg from your final destination back to your starting time zone, using the total miles of all forward legs.</p>
            </div>
        </div>

        <button id="toggleChainingBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
            Show Destination Chaining Options
        </button>

        <div id="chainingOptions" class="hidden">
            <h2>Additional Trip Legs</h2>
            <div id="legsContainer">
                <!-- Dynamic legs (Leg 2, Leg 3, etc.) will be added here by JS -->
            </div>
            <button id="addLegBtn" class="add-leg-btn rounded-xl">Add Another Destination Leg</button>
        </div>
        <!-- theBacchanalian -->
        <button id="toggleLogSheetBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
            Show Log Sheet Tracker
        </button>

        <div id="logSheetSection" class="hidden">
            <h2>Daily Log Sheet</h2>
            <p id="hosDisclaimer" class="disclaimer-note">
                The calculator’s HOS logic is a practical simulation, not a full regulatory compliance tool.
            </p>
            <div class="log-input-group">
                <label for="logDate">Log Date:</label>
                <input type="date" id="logDate" class="rounded-xl">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="linkLogsToCalculator">
                <label for="linkLogsToCalculator">Link Logs to ETA Calculator</label>
                <p class="tip">
                    If checked, the "Estimated Daily Driving Limit" (in the main calculator) and "Current 70-Hour Clock Hours" (in Advanced HOS Options) will automatically update based on your log entries. Otherwise, they will remain manual.
                </p>
            </div>

            <div class="log-form">
                <h3>Add/Edit Log Entry</h3>
                <div class="log-input-group">
                    <label for="startTime">Start Time:</label>
                    <input type="time" id="startTime" class="rounded-xl">
                </div>
                <div class="log-input-group">
                    <label for="endTime">End Time:</label>
                    <input type="time" id="endTime" class="rounded-xl">
                </div>
                <div class="log-input-group">
                    <label for="dutyStatus">Duty Status:</label>
                    <select id="dutyStatus" class="rounded-xl">
                        <option value="">Select Status</option>
                        <option value="Off-Duty">Off-Duty</option>
                        <option value="Sleeper Berth">Sleeper Berth</option>
                        <option value="Driving">Driving</option>
                        <option value="On-Duty Not Driving">On-Duty Not Driving</option>
                    </select>
                </div>
                <div class="log-input-group">
                    <label for="logRemarks">Location/Remarks:</label>
                    <textarea id="logRemarks" rows="2" placeholder="e.g., New York, NY / Pre-trip inspection" class="rounded-xl"></textarea>
                </div>
                <button id="addLogEntryBtn" class="rounded-xl">Add Log Entry</button>
            </div>

            <div class="log-table-container">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Start</th>
                            <th>End</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Location/Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logEntriesTableBody">
                        <!-- Log entries will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="log-summary" id="dailyLogSummary">
                <p><strong>Daily Driving:</strong> 0h 0m</p>
                <p><strong>Daily On-Duty:</strong> 0h 0m</p>
                <p><strong>Daily Off-Duty:</strong> 0h 0m</p>
                <p><strong>Daily Sleeper:</strong> 0h 0m</p>
            </div>
        </div>

        <div id="advancedResult" class="result-area bg-blue-100 text-teal-800">
            Advanced ETA will appear here.
        </div>

        <div id="errorMessage" class="error-message"></div>

        <div class="footer-content">
            <!-- theBacchanalian -->
            <p class="text-sm mt-2">
                *HOS Disclaimer: The calculator’s HOS logic is a practical simulation, not a full regulatory compliance tool.
            </p>
            <div class="qr-code-container">
                <img id="qrCodeImage" src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://cyraunyielding.github.io/Trucker-ETA-Calculator/" alt="QR Code to Calculator">
                <p>Scan to share this calculator!</p>
            </div>

            <!-- PayPal Button Integration -->
            <div class="paypal-button-container mt-4">
                <p class="text-base font-semibold text-gray-700 mb-2">Support This Project:</p>
                <div id="paypal-container-JSEAH3HWUE9VG"></div>
            </div>

            <p>Authored by Mark Bird</p>
            <a id="githubLink" href="https://github.com/cyraunyielding" target="_blank" rel="noopener noreferrer">Visit my GitHub</a>
            <a id="issuesLink" href="https://github.com/cyraunyielding/Trucker-ETA-Calculator/issues" target="_blank" rel="noopener noreferrer">Report Issues or Suggestions</a>

            <button id="toggleAnnouncementsBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
                Show Announcements
            </button>

            <!-- New Collapsible Announcements Section Content -->
            <div id="announcementsSectionContent" class="hidden">
                <h2>Announcements</h2>
                <div id="adminAnnouncementInput" class="announcement-input-group hidden">
                    <label for="announcementInput">New Announcement:</label>
                    <textarea id="announcementInput" rows="3" placeholder="Type your announcement here..." class="rounded-xl"></textarea>
                    <button id="saveAnnouncementBtn" class="rounded-xl">Post Announcement</button>
                </div>
                <div class="announcements-display-area" id="announcementsDisplayArea">
                    <p class="text-center text-gray-500">No announcements yet.</p>
                </div>
            </div>
            <!-- End New Collapsible Announcements Section Content -->

            <button id="showCommentsBtn" class="rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
                The Comments Section
            </button>

            <!-- Collapsible Comments Section Content -->
            <div id="commentsSectionContent" class="hidden">
                <h2>Comments & Feedback</h2>
                <div class="comment-input-group">
                    <textarea id="commentInput" rows="4" placeholder="Share your thoughts or suggestions here..." class="rounded-xl"></textarea>
                </div>
                <button id="submitCommentBtn" class="rounded-xl">Submit Comment</button>
                <div class="comments-display-area" id="commentsDisplayArea">
                    <p class="text-center text-gray-500">Loading comments...</p>
                </div>
            </div>
            <!-- End Collapsible Comments Section Content -->

        </div>
    </div>

    <script>
        // IMPORTANT: Replace 'YOUR_GOOGLE_MAPS_API_KEY_HERE' with your actual Google Maps API Key.
        // This key needs to have the "Time Zone API" enabled.
        const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY_HERE';
        <!-- theBacchanalian -->
        // Ensure Firebase instances are available globally (from the module script in head)
        let db;
        let auth;
        let getFirebaseUserId;
        let getIsAuthReady; // New function to check auth readiness
        let appId; // Global appId
        let getAdminUID; // Function to get ADMIN_UID

        // Wait for the DOM to be fully loaded and Firebase to be initialized
        document.addEventListener('DOMContentLoaded', async () => {
            // Assign global Firebase instances once available
            db = window.firebaseDb;
            auth = window.firebaseAuth;
            getFirebaseUserId = window.getFirebaseUserId;
            getIsAuthReady = window.getIsAuthReady;
            appId = window.appId; // This will now be 'trucker-eta-calculator-app'
            getAdminUID = window.getAdminUID; // Get the ADMIN_UID function

            // Global inputs (now representing Leg 1)
            const milesInput = document.getElementById('miles'); // Now for Leg 1
            const speedInput = document.getElementById('speed');
            const dailyDrivingLimitSelect = document.getElementById('dailyDrivingLimit');
            const currentTZSelect = document.getElementById('currentTZ'); // Trip start TZ
            const destinationTZSelect = document.getElementById('destinationTZ'); // Leg 1 Destination TZ Select

            // New Lat/Lon toggle elements for CURRENT location (manual input)
            const showManualCurrentLatLonCheckbox = document.getElementById('showManualCurrentLatLon');
            const manualCurrentLatLonOptionsDiv = document.getElementById('manualCurrentLatLonOptions');
            const currentLatInput = document.getElementById('currentLat');
            const currentLonInput = document.getElementById('currentLon');
            const currentInferredTZDisplay = document.getElementById('currentInferredTZDisplay');

            // Lat/Lon toggle elements for DESTINATION (Leg 1)
            const showDestLatLon1Checkbox = document.getElementById('showDestLatLon1');
            const leg1DestLatLonOptionsDiv = document.getElementById('leg1DestLatLonOptions');
            const destinationLatInput = document.getElementById('destinationLat');
            const destinationLonInput = document.getElementById('destinationLon');
            const leg1DestinationTZDisplay = document.getElementById('leg1DestinationTZDisplay');


            // Buttons and sections
            const calculateBtn = document.getElementById('calculateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const toggleAdvancedBtn = document.getElementById('toggleAdvancedBtn');
            const toggleChainingBtn = document.getElementById('toggleChainingBtn');
            const toggleLogSheetBtn = document.getElementById('toggleLogSheetBtn'); // New toggle for log sheet
            const updateLocationBtn = document.getElementById('updateLocationBtn'); // GPS location button
            const advancedOptionsDiv = document.getElementById('advancedOptions');
            const chainingOptionsDiv = document.getElementById('chainingOptions');
            const logSheetSection = document.getElementById('logSheetSection'); // New log sheet section

            // Advanced HOS options
            const plannedDailyBreakTotalInput = document.getElementById('plannedDailyBreakTotal'); // New
            const onDutyPortionOfDailyBreakInput = document.getElementById('onDutyPortionOfDailyBreak'); // New
            const apply14HourRuleCheckbox = document.getElementById('apply14HourRule');
            const include10HourOffDutyCheckbox = document.getElementById('include10HourOffDuty');
            const consider70HourClockCheckbox = document.getElementById('consider70HourClock');
            const current70HourClockInput = document.getElementById('current70HourClock');
            const bufferPercentageInput = document.getElementById('bufferPercentage');
            const enableRoundTripCheckbox = document.getElementById('enableRoundTrip');

            // Results and error display
            const resultDiv = document.getElementById('result');
            const advancedResultDiv = document.getElementById('advancedResult');
            const errorMessageDiv = document.getElementById('errorMessage');
            const currentLocationDisplay = document.getElementById('currentLocationDisplay'); // GPS location display

            // Chaining specific elements
            const legsContainer = document.getElementById('legsContainer');
            const addLegBtn = document.getElementById('addLegBtn');
            let legCounter = 1; // Start at 1, as the first leg is in the main section

            // Log Sheet specific elements
            const logDateInput = document.getElementById('logDate');
            const linkLogsToCalculatorCheckbox = document.getElementById('linkLogsToCalculator');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            const dutyStatusSelect = document.getElementById('dutyStatus');
            const logRemarksInput = document.getElementById('logRemarks');
            const addLogEntryBtn = document.getElementById('addLogEntryBtn');
            const logEntriesTableBody = document.getElementById('logEntriesTableBody');
            const dailyLogSummary = document.getElementById('dailyLogSummary');

            // Comment Section elements (now inline)
            const showCommentsBtn = document.getElementById('showCommentsBtn');
            const commentsSectionContent = document.getElementById('commentsSectionContent'); // New element
            const commentInput = document.getElementById('commentInput');
            const submitCommentBtn = document.getElementById('submitCommentBtn');
            const commentsDisplayArea = document.getElementById('commentsDisplayArea');

            // Announcement Section elements (new)
            const toggleAnnouncementsBtn = document.getElementById('toggleAnnouncementsBtn');
            const announcementsSectionContent = document.getElementById('announcementsSectionContent');
            const adminAnnouncementInputDiv = document.getElementById('adminAnnouncementInput'); // The div containing input/save for admin
            const announcementInput = document.getElementById('announcementInput');
            const saveAnnouncementBtn = document.getElementById('saveAnnouncementBtn');
            const announcementsDisplayArea = document.getElementById('announcementsDisplayArea');

            // Branding elements
            const truckLogo = document.getElementById('truckLogo');
            const githubLink = document.getElementById('githubLink');
            const issuesLink = document.getElementById('issuesLink');
            const qrCodeImage = document.getElementById('qrCodeImage');

            // Define a comprehensive list of US time zones with their IANA IDs and display names
            const timeZones = [
                { id: 'America/New_York', name: 'Eastern Time (ET)' },
                { id: 'America/Detroit', name: 'Eastern Time (ET) - Michigan' },
                { id: 'America/Indianapolis', name: 'Eastern Time (ET) - Indiana (East)' },
                { id: 'America/Chicago', name: 'Central Time (CT)' },
                { id: 'America/Menominee', name: 'Central Time (CT) - Michigan (UP)' },
                { id: 'America/North_Dakota/Center', name: 'Central Time (CT) - North Dakota' },
                { id: 'America/Denver', name: 'Mountain Time (MT)' },
                { id: 'America/Boise', name: 'Mountain Time (MT) - Idaho (South)' },
                { id: 'America/Phoenix', name: 'Arizona Time (MST) - No DST' }, // Arizona doesn't observe DST
                { id: 'America/Los_Angeles', name: 'Pacific Time (PT)' },
                { id: 'America/Anchorage', name: 'Alaska Time (AKT)' },
                { id: 'America/Adak', name: 'Hawaii-Aleutian Time (HAT)' },
                { id: 'Pacific/Honolulu', name: 'Hawaii Standard Time (HST) - No DST' }
            ];

            // Function to populate time zone dropdowns
            function populateTimeZones(selectElement) {
                timeZones.sort((a, b) => a.name.localeCompare(b.name));

                // Clear existing options before populating
                selectElement.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select time zone...';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                selectElement.appendChild(defaultOption);

                timeZones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz.id;
                    option.textContent = tz.name;
                    selectElement.appendChild(option);
                });
            }

            // Populate initial time zone dropdowns
            populateTimeZones(currentTZSelect);
            populateTimeZones(destinationTZSelect); // Populate destination TZ

            // Set user's current time zone as default for trip start
            try {
                const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const matchingTZ = timeZones.find(tz => tz.id === userTimeZone);
                if (matchingTZ) {
                    currentTZSelect.value = userTimeZone;
                    destinationTZSelect.value = userTimeZone; // Also set destination to user's TZ by default
                } else {
                    currentTZSelect.value = '';
                    destinationTZSelect.value = '';
                }
            } catch (e) {
                console.error("Could not determine user's time zone:", e);
                currentTZSelect.value = '';
                destinationTZSelect.value = '';
            }

            // Utility function to format date for Firestore document ID (YYYY-MM-DD)
            function formatDateForFirestore(dateObj) {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Set log date to today by default
            logDateInput.value = formatDateForFirestore(new Date());

            // --- Time Zone API Function ---
            // Cache for time zone lookups to avoid redundant API calls
            const timeZoneCache = {};

            async function getTimeZoneFromCoordinates(lat, lon, elementToUpdate, identifier = 'unknown') {
                // If Lat/Lon are invalid, return null to indicate failure to infer
                if (lat === null || lon === null || isNaN(lat) || isNaN(lon)) {
                    elementToUpdate.textContent = ''; // Clear display if no valid coords
                    return null;
                }

                const cacheKey = `${lat},${lon}`;
                if (timeZoneCache[cacheKey]) {
                    elementToUpdate.textContent = `Inferred TZ: ${timeZoneCache[cacheKey].name} (${timeZoneCache[cacheKey].id})`;
                    return timeZoneCache[cacheKey].id;
                }

                if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY_HERE') {
                    errorMessageDiv.textContent = 'Google Maps API Key is missing or invalid. Time Zone lookup will not work.';
                    elementToUpdate.textContent = 'API Key Missing (Cannot Infer TZ)';
                    console.error('Google Maps API Key is missing or invalid.');
                    return null; // Cannot infer without key
                }

                elementToUpdate.textContent = 'Fetching Time Zone...';
                const timestamp = Math.floor(Date.now() / 1000); // Current timestamp in seconds
                const url = `https://maps.googleapis.com/maps/api/timezone/json?location=${lat},${lon}&timestamp=${timestamp}&key=${GOOGLE_MAPS_API_KEY}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.status === 'OK') {
                        const timeZoneId = data.timeZoneId;
                        const timeZoneName = data.timeZoneName;
                        timeZoneCache[cacheKey] = { id: timeZoneId, name: timeZoneName };
                        elementToUpdate.textContent = `Inferred TZ: ${timeZoneName} (${timeZoneId})`;
                        return timeZoneId;
                    } else {
                        errorMessageDiv.textContent = `Error fetching time zone for ${identifier}: ${data.errorMessage || data.status}.`;
                        elementToUpdate.textContent = `Error: ${data.status} (Cannot Infer TZ)`;
                        console.error(`Time Zone API Error for ${identifier}:`, data);
                        return null; // Cannot infer on API error
                    }
                } catch (error) {
                    errorMessageDiv.textContent = `Network error fetching time zone for ${identifier}.`;
                    elementToUpdate.textContent = 'Network Error (Cannot Infer TZ)';
                    console.error(`Network error fetching time zone for ${identifier}:`, error);
                    return null; // Cannot infer on network error
                }
            }

            // Event Listeners for Manual Current Lat/Lon toggle
            showManualCurrentLatLonCheckbox.addEventListener('change', async () => {
                manualCurrentLatLonOptionsDiv.classList.toggle('hidden', !showManualCurrentLatLonCheckbox.checked);
                manualCurrentLatLonOptionsDiv.classList.toggle('block', showManualCurrentLatLonCheckbox.checked);
                if (showManualCurrentLatLonCheckbox.checked && currentLatInput.value && currentLonInput.value) {
                    await getTimeZoneFromCoordinates(parseFloat(currentLatInput.value), parseFloat(currentLonInput.value), currentInferredTZDisplay, 'Current Location');
                } else {
                    currentInferredTZDisplay.textContent = ''; // Clear inferred TZ display
                }
                calculateETA();
                saveCalculatorState();
            });

            currentLatInput.addEventListener('input', async () => {
                if (showManualCurrentLatLonCheckbox.checked) {
                    await getTimeZoneFromCoordinates(parseFloat(currentLatInput.value), parseFloat(currentLonInput.value), currentInferredTZDisplay, 'Current Location');
                }
                calculateETA(); saveCalculatorState();
            });
            currentLonInput.addEventListener('input', async () => {
                if (showManualCurrentLatLonCheckbox.checked) {
                    await getTimeZoneFromCoordinates(parseFloat(currentLatInput.value), parseFloat(currentLonInput.value), currentInferredTZDisplay, 'Current Location');
                }
                calculateETA(); saveCalculatorState();
            });


            // Event listeners for Leg 1 Destination Lat/Lon toggles
            showDestLatLon1Checkbox.addEventListener('change', async () => {
                leg1DestLatLonOptionsDiv.classList.toggle('hidden', !showDestLatLon1Checkbox.checked);
                leg1DestLatLonOptionsDiv.classList.toggle('block', showDestLatLon1Checkbox.checked);
                // If lat/lon inputs are shown, try to infer TZ immediately
                if (showDestLatLon1Checkbox.checked && destinationLatInput.value && destinationLonInput.value) {
                    await getTimeZoneFromCoordinates(parseFloat(destinationLatInput.value), parseFloat(destinationLonInput.value), leg1DestinationTZDisplay, 'Leg 1 Destination');
                } else {
                    leg1DestinationTZDisplay.textContent = ''; // Clear inferred TZ display
                }
                calculateETA();
                saveCalculatorState();
            });

            // Event listeners for Leg 1 Destination Lat/Lon inputs to trigger TZ inference and calculation
            destinationLatInput.addEventListener('input', async () => {
                if (showDestLatLon1Checkbox.checked) { // Only infer if lat/lon section is visible
                    await getTimeZoneFromCoordinates(parseFloat(destinationLatInput.value), parseFloat(destinationLonInput.value), leg1DestinationTZDisplay, 'Leg 1 Destination');
                }
                calculateETA(); saveCalculatorState();
            });
            destinationLonInput.addEventListener('input', async () => {
                if (showDestLatLon1Checkbox.checked) { // Only infer if lat/lon section is visible
                    await getTimeZoneFromCoordinates(parseFloat(destinationLonInput.value), parseFloat(destinationLonInput.value), leg1DestinationTZDisplay, 'Leg 1 Destination');
                }
                calculateETA(); saveCalculatorState();
            });


            // --- Local Storage Persistence Functions ---
            function saveCalculatorState() {
                const state = {
                    miles: milesInput.value,
                    speed: speedInput.value,
                    dailyDrivingLimit: dailyDrivingLimitSelect.value,
                    currentTZ: currentTZSelect.value,
                    destinationTZ: destinationTZSelect.value,
                    showManualCurrentLatLon: showManualCurrentLatLonCheckbox.checked, // Save new checkbox state
                    currentLat: currentLatInput.value, // Save new manual current lat
                    currentLon: currentLonInput.value, // Save new manual current lon
                    showDestLatLon1: showDestLatLon1Checkbox.checked,
                    destinationLat: destinationLatInput.value,
                    destinationLon: destinationLonInput.value,
                    plannedDailyBreakTotal: plannedDailyBreakTotalInput.value,
                    onDutyPortionOfDailyBreak: onDutyPortionOfDailyBreakInput.value,
                    apply14HourRule: apply14HourRuleCheckbox.checked,
                    include10HourOffDuty: include10HourOffDutyCheckbox.checked,
                    consider70HourClock: consider70HourClockCheckbox.checked,
                    current70HourClock: current70HourClockInput.value,
                    bufferPercentage: bufferPercentageInput.value,
                    enableRoundTrip: enableRoundTripCheckbox.checked,
                    linkLogsToCalculator: linkLogsToCalculatorCheckbox.checked,
                    legs: [],
                    // Store visibility states of collapsible sections
                    advancedOptionsVisible: !advancedOptionsDiv.classList.contains('hidden'),
                    chainingOptionsVisible: !chainingOptionsDiv.classList.contains('hidden'),
                    logSheetVisible: !logSheetSection.classList.contains('hidden'),
                    commentsSectionVisible: !commentsSectionContent.classList.contains('hidden'),
                    announcementsSectionVisible: !announcementsSectionContent.classList.contains('hidden')
                };

                // Save dynamic legs
                const dynamicLegSections = legsContainer.querySelectorAll('.leg-section');
                dynamicLegSections.forEach((legElement, index) => {
                    const legNumber = index + 2;
                    state.legs.push({
                        miles: legElement.querySelector(`#miles-${legNumber}`).value,
                        destTZ: legElement.querySelector(`#destinationTZ-${legNumber}`).value,
                        destLat: legElement.querySelector(`#destinationLat-${legNumber}`).value,
                        destLon: legElement.querySelector(`#destinationLon-${legNumber}`).value,
                        showDestLatLon: legElement.querySelector(`#showDestLatLon-${legNumber}`).checked
                    });
                });

                localStorage.setItem('truckerCalculatorState', JSON.stringify(state));
                console.log("Calculator state saved to local storage.");
            }

            async function loadCalculatorState() {
                const savedState = localStorage.getItem('truckerCalculatorState');
                if (savedState) {
                    const state = JSON.parse(savedState);

                    milesInput.value = state.miles || '';
                    speedInput.value = state.speed || '';
                    // Handle dailyDrivingLimit separately to ensure option exists
                    if (state.dailyDrivingLimit) {
                        let optionExists = false;
                        for (let i = 0; i < dailyDrivingLimitSelect.options.length; i++) {
                            if (dailyDrivingLimitSelect.options[i].value === state.dailyDrivingLimit) {
                                optionExists = true;
                                break;
                            }
                        }
                        if (!optionExists) {
                            const newOption = document.createElement('option');
                            newOption.value = state.dailyDrivingLimit;
                            newOption.textContent = `${state.dailyDrivingLimit} Hours (saved)`;
                            dailyDrivingLimitSelect.appendChild(newOption);
                        }
                        dailyDrivingLimitSelect.value = state.dailyDrivingLimit;
                    } else {
                        dailyDrivingLimitSelect.value = '11';
                    }

                    // Re-populate time zones after setting values to ensure options exist
                    populateTimeZones(currentTZSelect);
                    populateTimeZones(destinationTZSelect);

                    currentTZSelect.value = state.currentTZ || '';
                    destinationTZSelect.value = state.destinationTZ || '';

                    // Load and apply new manual current Lat/Lon checkbox state
                    showManualCurrentLatLonCheckbox.checked = state.showManualCurrentLatLon || false;
                    manualCurrentLatLonOptionsDiv.classList.toggle('hidden', !showManualCurrentLatLonCheckbox.checked);
                    manualCurrentLatLonOptionsDiv.classList.toggle('block', showManualCurrentLatLonCheckbox.checked);
                    currentLatInput.value = state.currentLat || '';
                    currentLonInput.value = state.currentLon || '';
                    if (showManualCurrentLatLonCheckbox.checked && currentLatInput.value && currentLonInput.value) {
                        await getTimeZoneFromCoordinates(parseFloat(currentLatInput.value), parseFloat(currentLonInput.value), currentInferredTZDisplay, 'Current Location');
                    } else {
                        currentInferredTZDisplay.textContent = '';
                    }

                    // Load and apply destination Lat/Lon checkbox state
                    showDestLatLon1Checkbox.checked = state.showDestLatLon1 || false;
                    leg1DestLatLonOptionsDiv.classList.toggle('hidden', !showDestLatLon1Checkbox.checked);
                    leg1DestLatLonOptionsDiv.classList.toggle('block', showDestLatLon1Checkbox.checked);
                    destinationLatInput.value = state.destinationLat || '';
                    destinationLonInput.value = state.destinationLon || '';
                    if (showDestLatLon1Checkbox.checked && destinationLatInput.value && destinationLonInput.value) {
                         await getTimeZoneFromCoordinates(parseFloat(destinationLatInput.value), parseFloat(destinationLonInput.value), leg1DestinationTZDisplay, 'Leg 1 Destination');
                    } else {
                        leg1DestinationTZDisplay.textContent = '';
                    }


                    plannedDailyBreakTotalInput.value = state.plannedDailyBreakTotal !== undefined ? state.plannedDailyBreakTotal : '1';
                    onDutyPortionOfDailyBreakInput.value = state.onDutyPortionOfDailyBreak !== undefined ? state.onDutyPortionOfDailyBreak : '0.5';
                    apply14HourRuleCheckbox.checked = state.apply14HourRule || false;
                    include10HourOffDutyCheckbox.checked = state.include10HourOffDuty || false;
                    consider70HourClockCheckbox.checked = state.consider70HourClock || false;
                    current70HourClockInput.value = state.current70HourClock || '';
                    bufferPercentageInput.value = state.bufferPercentage || '';
                    enableRoundTripCheckbox.checked = state.enableRoundTrip || false;
                    linkLogsToCalculatorCheckbox.checked = state.linkLogsToCalculator || false;


                    // Load dynamic legs
                    legsContainer.innerHTML = ''; // Clear existing dynamic legs
                    legCounter = 1; // Reset counter
                    if (state.legs && state.legs.length > 0) {
                        for (const legData of state.legs) { // Use for...of for await inside loop
                            await addLeg(legData.miles, legData.destTZ, legData.destLat, legData.destLon, legData.showDestLatLon); // Pass all saved data
                        }
                    }

                    // Restore visibility of collapsible sections
                    if (state.advancedOptionsVisible) {
                        advancedOptionsDiv.classList.remove('hidden');
                        advancedOptionsDiv.classList.add('block');
                        toggleAdvancedBtn.textContent = 'Hide Advanced HOS Options';
                    } else {
                        advancedOptionsDiv.classList.add('hidden');
                        advancedOptionsDiv.classList.remove('block');
                        toggleAdvancedBtn.textContent = 'Show Advanced HOS Options';
                    }
                    if (state.chainingOptionsVisible) {
                        chainingOptionsDiv.classList.remove('hidden');
                        chainingOptionsDiv.classList.add('block');
                        toggleChainingBtn.textContent = 'Hide Destination Chaining Options';
                    } else {
                        chainingOptionsDiv.classList.add('hidden');
                        chainingOptionsDiv.classList.remove('block');
                        toggleChainingBtn.textContent = 'Show Destination Chaining Options';
                    }
                    if (state.logSheetVisible) {
                        logSheetSection.classList.remove('hidden');
                        logSheetSection.classList.add('block');
                        toggleLogSheetBtn.textContent = 'Hide Log Sheet Tracker';
                    } else {
                        logSheetSection.classList.add('hidden');
                        logSheetSection.classList.remove('block');
                        toggleLogSheetBtn.textContent = 'Show Log Sheet Tracker';
                    }
                    // Restore comments section visibility
                    if (state.commentsSectionVisible) {
                        commentsSectionContent.classList.remove('hidden');
                        commentsSectionContent.classList.add('block');
                        showCommentsBtn.textContent = 'Hide Comments Section';
                    } else {
                        commentsSectionContent.classList.add('hidden');
                        commentsSectionContent.classList.remove('block');
                        showCommentsBtn.textContent = 'The Comments Section';
                    }
                    // Restore announcements section visibility
                    if (state.announcementsSectionVisible) {
                        announcementsSectionContent.classList.remove('hidden');
                        announcementsSectionContent.classList.add('block');
                        toggleAnnouncementsBtn.textContent = 'Hide Announcements';
                    } else {
                        announcementsSectionContent.classList.add('hidden');
                        announcementsSectionContent.classList.remove('block');
                        toggleAnnouncementsBtn.textContent = 'Show Announcements';
                    }

                    // Apply linked state immediately after loading
                    const isLinked = linkLogsToCalculatorCheckbox.checked;
                    dailyDrivingLimitSelect.disabled = isLinked;
                    dailyDrivingLimitSelect.readOnly = isLinked;
                    current70HourClockInput.disabled = isLinked;
                    current70HourClockInput.readOnly = isLinked;
                    Array.from(dailyDrivingLimitSelect.options).forEach(option => {
                        option.disabled = isLinked;
                    });


                    console.log("Calculator state loaded from local storage.");
                }
            }

            // --- Geolocation Functionality ---
            updateLocationBtn.addEventListener('click', () => {
                if (navigator.geolocation) {
                    currentLocationDisplay.textContent = 'Getting location...';
                    errorMessageDiv.textContent = '';
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude.toFixed(6);
                            const lon = position.coords.longitude.toFixed(6);
                            currentLocationDisplay.textContent = `Lat: ${lat}, Lon: ${lon}`;
                            // You could potentially use these coordinates to auto-fill a location in the log sheet,
                            // or for future features like reverse geocoding to get an address.
                            // For now, just displaying them.
                        },
                        (error) => {
                            let msg = 'Error getting location: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    msg += "User denied the request for Geolocation.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    msg += "Location information is unavailable.";
                                    break;
                                case error.TIMEOUT:
                                    msg += "The request to get user location timed out.";
                                    break;
                                case error.UNKNOWN_ERROR:
                                    msg += "An unknown error occurred.";
                                    break;
                            }
                            currentLocationDisplay.textContent = ''; // Clear loading message
                            errorMessageDiv.textContent = msg;
                            console.error("Geolocation error:", error);
                        },
                        {
                            enableHighAccuracy: true, // Request the best possible result
                            timeout: 10000,           // Maximum time (ms) to wait for a position
                            maximumAge: 0             // Don't use a cached position
                        }
                    );
                } else {
                    errorMessageDiv.textContent = 'Geolocation is not supported by your browser.';
                    currentLocationDisplay.textContent = '';
                }
            });


            // --- Log Sheet Functions ---
            let currentDayLogs = []; // Array to hold logs for the currently selected date

            // Function to save logs for the current day to Firestore
            async function saveCurrentDayLogs() {
                const userId = getFirebaseUserId();
                if (!userId || !db || !getIsAuthReady()) {
                    console.warn("User not authenticated or Firestore not ready. Cannot save logs.");
                    errorMessageDiv.textContent = "Authentication not ready. Cannot save logs.";
                    return;
                }

                const selectedDate = logDateInput.value;
                if (!selectedDate) {
                    errorMessageDiv.textContent = "Please select a date for the log entry.";
                    return;
                }

                const docRef = doc(db, `artifacts/${appId}/users/${userId}/log_sheets`, selectedDate);
                try {
                    // Firestore has limitations on deeply nested arrays, so we stringify the array of entries
                    await setDoc(docRef, { entries: JSON.stringify(currentDayLogs) });
                    console.log(`Logs for ${selectedDate} saved successfully.`);
                    errorMessageDiv.textContent = ''; // Clear any previous error
                    calculateDailySummary(); // Recalculate summary after saving
                    if (linkLogsToCalculatorCheckbox.checked) {
                        // Trigger HOS calculation from logs and update ETA
                        updateHOSFromLogs();
                    }
                } catch (e) {
                    console.error("Error saving logs:", e);
                    errorMessageDiv.textContent = "Error saving log entry. Please try again.";
                }
            }

            // Function to load logs for a specific date from Firestore
            function loadLogsForSelectedDate() {
                const userId = getFirebaseUserId();
                if (!userId || !db || !getIsAuthReady()) {
                    // console.warn("User not authenticated or Firestore not ready. Cannot load logs.");
                    return; // Don't show error, as this might be called before auth is ready
                }

                const selectedDate = logDateInput.value;
                if (!selectedDate) {
                    logEntriesTableBody.innerHTML = '';
                    currentDayLogs = [];
                    calculateDailySummary();
                    return;;
                }

                const docRef = doc(db, `artifacts/${appId}/users/${userId}/log_sheets`, selectedDate);

                // Use onSnapshot for real-time updates
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        try {
                            currentDayLogs = JSON.parse(data.entries || '[]');
                        } catch (e) {
                            console.error("Error parsing log entries from Firestore:", e);
                            currentDayLogs = [];
                        }
                    } else {
                        currentDayLogs = []; // No logs for this date
                    }
                    renderLogEntries();
                    calculateDailySummary();
                    if (linkLogsToCalculatorCheckbox.checked) {
                        updateHOSFromLogs();
                    }
                }, (error) => {
                    console.error("Error fetching real-time logs:", error);
                    errorMessageDiv.textContent = "Error loading log entries.";
                    currentDayLogs = [];
                    renderLogEntries();
                    calculateDailySummary();
                });
            }

            // Function to render log entries in the table
            function renderLogEntries() {
                logEntriesTableBody.innerHTML = '';
                if (currentDayLogs.length === 0) {
                    logEntriesTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No log entries for this date.</td></tr>';
                    return;
                }

                currentDayLogs.sort((a, b) => {
                    const timeA = new Date(`2000/01/01 ${a.startTime}`);
                    const timeB = new Date(`2000/01/01 ${b.startTime}`);
                    return timeA - timeB;
                });

                currentDayLogs.forEach((entry, index) => {
                    const row = logEntriesTableBody.insertRow();
                    const duration = calculateDuration(entry.startTime, entry.endTime);
                    row.innerHTML = `
                        <td>${entry.startTime}</td>
                        <td>${entry.endTime}</td>
                        <td>${entry.status}</td>
                        <td>${formatDuration(duration)}</td>
                        <td>${entry.remarks}</td>
                        <td>
                            <button type="button" class="edit-log-btn rounded-md bg-blue-500 hover:bg-blue-600 text-white" data-index="${index}">Edit</button>
                            <button type="button" class="delete-log-btn rounded-md" data-index="${index}">Delete</button>
                        </td>
                    `;
                });
            }

            // Helper to calculate duration in minutes
            function calculateDuration(startTime, endTime) {
                const start = new Date(`2000/01/01 ${startTime}`);
                let end = new Date(`2000/01/01 ${endTime}`);
                // Handle overnight entries (end time is on the next day)
                if (end < start) {
                    end.setDate(end.getDate() + 1);
                }
                return (end - start) / (1000 * 60); // Duration in minutes
            }

            // Helper to format duration into Hh Mm
            function formatDuration(minutes) {
                if (minutes < 0) return "Invalid";
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = Math.round(minutes % 60); // Round to nearest minute
                return `${hours}h ${remainingMinutes}m`;
            }

            // Function to calculate and display daily summary
            function calculateDailySummary() {
                let totalDrivingMinutes = 0;
                let totalOnDutyMinutes = 0; // Includes Driving and On-Duty Not Driving
                let totalOffDutyMinutes = 0;
                let totalSleeperMinutes = 0;

                currentDayLogs.forEach(entry => {
                    const duration = calculateDuration(entry.startTime, entry.endTime);
                    if (duration < 0) return; // Skip invalid entries

                    switch (entry.status) {
                        case 'Driving':
                            totalDrivingMinutes += duration;
                            totalOnDutyMinutes += duration;
                            break;
                        case 'On-Duty Not Driving':
                            totalOnDutyMinutes += duration;
                            break;
                        case 'Off-Duty':
                            totalOffDutyMinutes += duration;
                            break;
                        case 'Sleeper Berth':
                            totalSleeperMinutes += duration;
                            break;
                    }
                });

                dailyLogSummary.innerHTML = `
                    <p><strong>Daily Driving:</strong> ${formatDuration(totalDrivingMinutes)}</p>
                    <p><strong>Daily On-Duty:</strong> ${formatDuration(totalOnDutyMinutes)}</p>
                    <p><strong>Daily Off-Duty:</strong> ${formatOffDutyTime(totalOffDutyMinutes)}</p>
                    <p><strong>Daily Sleeper:</strong> ${formatDuration(totalSleeperMinutes)}</p>
                `;
            }

            // Helper to format off-duty time, showing 10h if available
            function formatOffDutyTime(minutes) {
                if (minutes >= 10 * 60) {
                    return `${formatDuration(minutes)} (10h break met)`;
                }
                return formatDuration(minutes);
            }

            // Function to add/edit a log entry
            addLogEntryBtn.addEventListener('click', () => {
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;
                const dutyStatus = dutyStatusSelect.value;
                const remarks = logRemarksInput.value.trim();

                if (!startTime || !endTime || !dutyStatus) {
                    errorMessageDiv.textContent = "Please fill in Start Time, End Time, and Duty Status.";
                    return;
                }
                if (calculateDuration(startTime, endTime) <= 0) {
                    errorMessageDiv.textContent = "End Time must be after Start Time.";
                    return;
                }

                const newEntry = {
                    startTime,
                    endTime,
                    status: dutyStatus,
                    remarks
                };

                // Check if we are editing an existing entry
                const editingIndex = addLogEntryBtn.dataset.editingIndex;
                if (editingIndex !== undefined && editingIndex !== null && editingIndex !== "") {
                    currentDayLogs[parseInt(editingIndex)] = newEntry;
                    addLogEntryBtn.textContent = 'Add Log Entry'; // Change button back
                    addLogEntryBtn.removeAttribute('data-editing-index');
                } else {
                    currentDayLogs.push(newEntry);
                }

                // Clear form
                startTimeInput.value = '';
                endTimeInput.value = '';
                dutyStatusSelect.value = '';
                logRemarksInput.value = '';

                saveCurrentDayLogs(); // Save to Firestore
            });

            // Event listener for edit/delete buttons on the table body
            logEntriesTableBody.addEventListener('click', (event) => {
                const target = event.target;
                const index = parseInt(target.dataset.index);

                if (target.classList.contains('edit-log-btn')) {
                    const entryToEdit = currentDayLogs[index];
                    startTimeInput.value = entryToEdit.startTime;
                    endTimeInput.value = entryToEdit.endTime;
                    dutyStatusSelect.value = entryToEdit.status;
                    logRemarksInput.value = entryToEdit.remarks;
                    addLogEntryBtn.textContent = 'Save Changes'; // Change button text
                    addLogEntryBtn.dataset.editingIndex = index; // Store index for saving
                } else if (target.classList.contains('delete-log-btn')) {
                    // Using a simple confirm for now, will replace with custom modal later
                    if (window.confirm("Are you sure you want to delete this log entry?")) {
                        currentDayLogs.splice(index, 1);
                        saveCurrentDayLogs(); // Save updated array to Firestore
                    }
                }
            });

            // Event listener for date input change
            logDateInput.addEventListener('change', loadLogsForSelectedDate);

            // --- Linking Logs to Calculator HOS Logic ---
            linkLogsToCalculatorCheckbox.addEventListener('change', () => {
                const isLinked = linkLogsToCalculatorCheckbox.checked;
                dailyDrivingLimitSelect.disabled = isLinked; // Disable for user input
                dailyDrivingLimitSelect.readOnly = isLinked;
                current70HourClockInput.disabled = isLinked; // Disable for user input
                current70HourClockInput.readOnly = isLinked;

                // Visually disable select options if linked
                Array.from(dailyDrivingLimitSelect.options).forEach(option => {
                    option.disabled = isLinked;
                });

                if (isLinked) {
                    updateHOSFromLogs(); // Call the function to update from logs
                } else {
                    // Revert to default/manual state if unlinked
                    // Load from local storage or set to default if no local storage
                    loadCalculatorState(); // Re-load all state, which will restore manual values
                    // Ensure the dailyDrivingLimitSelect is re-enabled and its options are too
                    dailyDrivingLimitSelect.disabled = false;
                    dailyDrivingLimitSelect.readOnly = false;
                    current70HourClockInput.disabled = false;
                    current70HourClockInput.readOnly = false;
                    Array.from(dailyDrivingLimitSelect.options).forEach(option => {
                        option.disabled = false;
                    });
                    calculateETA(); // Recalculate ETA based on manual input
                }
                saveCalculatorState(); // Save the state of the checkbox
            });

            // Function to calculate and update current HOS status from logs
            async function updateHOSFromLogs() {
                const userId = getFirebaseUserId();
                if (!userId || !db || !getIsAuthReady()) {
                    console.warn("User not authenticated or Firestore not ready. Cannot update HOS from logs.");
                    // Set inputs to default or 0 if not authenticated/ready
                    dailyDrivingLimitSelect.value = '11';
                    current70HourClockInput.value = '0';
                    calculateETA();
                    return;
                }

                // Fetch logs for the last 8 days (70-hour lookback)
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today to midnight for consistent date comparison

                const eightDaysAgo = new Date(today);
                eightDaysAgo.setDate(today.getDate() - 7); // Start 7 days before today, covering 8 days total (today + 7 previous)

                const allRelevantLogs = [];
                const logSheetCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/log_sheets`);

                // Fetch documents for the last 8 days
                for (let i = 0; i < 8; i++) {
                    const dateToFetch = new Date(eightDaysAgo);
                    dateToFetch.setDate(eightDaysAgo.getDate() + i);
                    const formattedDate = formatDateForFirestore(dateToFetch);
                    const docRef = doc(logSheetCollectionRef, formattedDate);
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const entries = JSON.parse(data.entries || '[]');
                            entries.forEach(entry => {
                                // Attach the full date-time to each entry for chronological processing
                                const startDateTime = new Date(`${formattedDate}T${entry.startTime}`);
                                let endDateTime = new Date(`${formattedDate}T${entry.endTime}`);
                                if (endDateTime < startDateTime) { // Handle overnight entries
                                    endDateTime.setDate(endDateTime.getDate() + 1);
                                }
                                allRelevantLogs.push({
                                    ...entry,
                                    startDateTime: startDateTime,
                                    endDateTime: endDateTime,
                                    durationMinutes: (endDateTime - startDateTime) / (1000 * 60)
                                });
                            });
                        }
                    } catch (e) {
                        console.error(`Error fetching logs for ${formattedDate}:`, e);
                    }
                }

                // Sort all entries chronologically
                allRelevantLogs.sort((a, b) => a.startDateTime - b.startDateTime);

                // --- HOS Rule Simulation ---
                let current70HourClockMinutes = 0;
                let currentDrivingHoursToday = 0;
                let currentOnDutyHoursToday = 0;
                let current14HourWindowEnd = null; // End time of the current 14-hour window
                let last10HourBreakEnd = null; // Timestamp of the end of the last qualifying 10-hour break
                let last34HourResetEnd = null; // Timestamp of the end of the last qualifying 34-hour reset

                // Iterate through logs to simulate HOS from the start of the 8-day period
                for (let i = 0; i < allRelevantLogs.length; i++) {
                    const entry = allRelevantLogs[i];
                    const duration = entry.durationMinutes;

                    // If a 34-hour reset was completed *before or at the start* of this entry, reset 70-hour clock
                    if (last34HourResetEnd && entry.startDateTime >= last34HourResetEnd) {
                        current70HourClockMinutes = 0;
                        last34HourResetEnd = null; // Consume the reset
                    }

                    // If a 10-hour break was completed *before or at the start* of this entry, reset daily clocks
                    if (last10HourBreakEnd && entry.startDateTime >= last10HourBreakEnd) {
                        currentDrivingHoursToday = 0;
                        currentOnDutyHoursToday = 0;
                        current14HourWindowEnd = null; // Reset 14-hour window
                        last10HourBreakEnd = null; // Consume the break
                    }

                    // Update 70-hour clock
                    if (entry.status === 'Driving' || entry.status === 'On-Duty Not Driving') {
                        current70HourClockMinutes += duration;
                    }

                    // Check for 10-hour break and 34-hour reset completion
                    if (entry.status === 'Off-Duty' || entry.status === 'Sleeper Berth') {
                        if (duration >= (10 * 60)) { // 10-hour break
                            last10HourBreakEnd = entry.endDateTime;
                        }
                        if (duration >= (34 * 60)) { // 34-hour reset
                            last34HourResetEnd = entry.endDateTime;
                        }
                    }

                    // Calculate daily driving and on-duty for the *current day* (today)
                    // This is simplified. A real HOS system tracks this for *each* 24-hour period.
                    // For now, we'll just sum for the actual calendar day.
                    if (entry.endDateTime >= today) { // Check if the entry has any part in the current day
                        const startOfToday = today.getTime();
                        const segmentStart = Math.max(entry.startDateTime.getTime(), startOfToday);
                        const segmentEnd = entry.endDateTime.getTime();
                        const segmentDurationMinutes = (segmentEnd - segmentStart) / (1000 * 60);

                        if (segmentDurationMinutes > 0) {
                            if (entry.status === 'Driving') {
                                currentDrivingHoursToday += segmentDurationMinutes / 60;
                            }
                            if (entry.status === 'Driving' || entry.status === 'On-Duty Not Driving') {
                                currentOnDutyHoursToday += segmentDurationMinutes / 60;
                            }
                        }
                    }
                }

                // Determine effective 70-hour clock remaining
                let remaining70HourClock = Math.max(0, (70 * 60) - current70HourClockMinutes) / 60; // Convert back to hours

                // Determine effective daily driving limit for the calculator
                // This is still a simplified approach based on total driving today.
                // A full HOS system would consider the 11-hour rule from the start of the current shift.
                let effectiveDailyDrivingLimit = Math.max(0, 11 - currentDrivingHoursToday);
                effectiveDailyDrivingLimit = Math.min(effectiveDailyDrivingLimit, Math.max(0, 14 - currentOnDutyHoursToday - (parseFloat(onDutyPortionOfDailyBreakInput.value) || 0.5))); // Also consider 14-hour rule (minus on-duty break)

                // Update the calculator inputs
                // Ensure the dailyDrivingLimitSelect has an option for the calculated value
                // If the calculated value is not a standard option, we'll set it as a custom option.
                const calculatedDrivingLimit = effectiveDailyDrivingLimit.toFixed(2);
                let optionExists = false;
                for (let i = 0; i < dailyDrivingLimitSelect.options.length; i++) {
                    if (dailyDrivingLimitSelect.options[i].value === calculatedDrivingLimit) {
                        optionExists = true;
                        break;
                    }
                }
                if (!optionExists) {
                    const newOption = document.createElement('option');
                    newOption.value = calculatedDrivingLimit;
                    newOption.textContent = `${calculatedDrivingLimit} Hours (from logs)`;
                    dailyDrivingLimitSelect.appendChild(newOption);
                }
                dailyDrivingLimitSelect.value = calculatedDrivingLimit;
                current70HourClockInput.value = remaining70HourClock.toFixed(2);

                calculateETA(); // Recalculate ETA with the new HOS values
            }


            // Function to add a new leg
            async function addLeg(miles = '', destTZ = '', destLat = '', destLon = '', showDestLatLon = false) { // Added parameters for loading from local storage
                legCounter++; // This will make it Leg 2, Leg 3, etc.
                const newLegHtml = `
                    <div class="leg-section" id="leg-${legCounter}">
                        <h3>Leg ${legCounter}: Destination ${legCounter - 1} to Destination ${legCounter}</h3>
                        <button type="button" class="remove-leg-btn rounded-xl" data-leg-id="${legCounter}">Remove</button>
                        <div class="leg-input-group">
                            <label for="miles-${legCounter}">Miles for Leg ${legCounter}:</label>
                            <input type="number" id="miles-${legCounter}" placeholder="e.g., 500" class="rounded-xl" value="${miles}">
                        </div>
                        <div class="leg-input-group">
                            <label for="destinationTZ-${legCounter}">Destination Time Zone (Leg ${legCounter}):</label>
                            <select id="destinationTZ-${legCounter}" class="rounded-xl">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <p class="tip">The time zone of this destination. Lat/Long input will override this selection.</p>
                            <div class="checkbox-group mt-2"> <!-- Moved checkbox here -->
                                <input type="checkbox" id="showDestLatLon-${legCounter}" ${showDestLatLon ? 'checked' : ''}>
                                <label for="showDestLatLon-${legCounter}" class="text-sm font-normal">Lat/Long</label>
                            </div>
                        </div>
                        <!-- Lat/Lon Inputs for dynamic leg (hidden by default) -->
                        <div id="leg${legCounter}DestLatLonOptions" class="input-group ${showDestLatLon ? 'block' : 'hidden'}">
                            <div class="input-group">
                                <label for="destinationLat-${legCounter}">Destination Latitude (Leg ${legCounter}):</label>
                                <input type="number" id="destinationLat-${legCounter}" placeholder="e.g., 34.0522" step="0.000001" class="rounded-xl" value="${destLat}">
                            </div>
                            <div class="input-group">
                                <label for="destinationLon-${legCounter}">Destination Longitude (Leg ${legCounter}):</label>
                                <input type="number" id="destinationLon-${legCounter}" placeholder="e.g., -118.2437" step="0.000001" class="rounded-xl" value="${destLon}">
                            </div>
                            <div id="leg${legCounter}DestinationTZDisplay" class="location-display text-center"></div>
                            <p class="tip">Time zone will be inferred from these coordinates.</p>
                        </div>
                        <!-- End Lat/Lon Inputs for dynamic leg -->
                    </div>
                `;
                legsContainer.insertAdjacentHTML('beforeend', newLegHtml);

                // Get references to the new inputs and display div
                const newDestTZSelect = document.getElementById(`destinationTZ-${legCounter}`);
                const newShowDestLatLonCheckbox = document.getElementById(`showDestLatLon-${legCounter}`);
                const newDestLatLonOptionsDiv = document.getElementById(`leg${legCounter}DestLatLonOptions`);
                const newDestLatInput = document.getElementById(`destinationLat-${legCounter}`);
                const newDestLonInput = document.getElementById(`destinationLon-${legCounter}`);
                const newDestTZDisplay = document.getElementById(`leg${legCounter}DestinationTZDisplay`);

                // Populate time zones for the new dropdown
                populateTimeZones(newDestTZSelect);
                newDestTZSelect.value = destTZ; // Set saved value

                // Set initial visibility of lat/lon options
                newDestLatLonOptionsDiv.classList.toggle('hidden', !newShowDestLatLonCheckbox.checked);
                newDestLatLonOptionsDiv.classList.toggle('block', newShowDestLatLonCheckbox.checked);

                // Infer time zone for the new leg if lat/lon are shown and have values
                if (newShowDestLatLonCheckbox.checked && newDestLatInput.value && newDestLonInput.value) {
                    await getTimeZoneFromCoordinates(parseFloat(newDestLatInput.value), parseFloat(newDestLonInput.value), newDestTZDisplay, `Leg ${legCounter} Destination`);
                } else {
                    newDestTZDisplay.textContent = ''; // Clear display if not using lat/lon
                }

                // Add event listeners to new inputs for recalculation and saving state
                document.getElementById(`miles-${legCounter}`).addEventListener('input', () => { calculateETA(); saveCalculatorState(); });
                newDestTZSelect.addEventListener('change', () => { calculateETA(); saveCalculatorState(); }); // Listen for dropdown change
                newShowDestLatLonCheckbox.addEventListener('change', async () => {
                    newDestLatLonOptionsDiv.classList.toggle('hidden', !newShowDestLatLonCheckbox.checked);
                    newDestLatLonOptionsDiv.classList.toggle('block', newShowDestLatLonCheckbox.checked);
                    if (newShowDestLatLonCheckbox.checked && newDestLatInput.value && newDestLonInput.value) {
                        await getTimeZoneFromCoordinates(parseFloat(newDestLatInput.value), parseFloat(newDestLonInput.value), newDestTZDisplay, `Leg ${legCounter} Destination`);
                    } else {
                        newDestTZDisplay.textContent = '';
                    }
                    calculateETA(); saveCalculatorState();
                });
                newDestLatInput.addEventListener('input', async () => {
                    if (newShowDestLatLonCheckbox.checked) {
                        await getTimeZoneFromCoordinates(parseFloat(newDestLatInput.value), parseFloat(newDestLonInput.value), newDestTZDisplay, `Leg ${legCounter} Destination`);
                    }
                    calculateETA(); saveCalculatorState();
                });
                newDestLonInput.addEventListener('input', async () => {
                    if (newShowDestLatLonCheckbox.checked) {
                        await getTimeZoneFromCoordinates(parseFloat(newDestLatInput.value), parseFloat(newDestLonInput.value), newDestTZDisplay, `Leg ${legCounter} Destination`);
                    }
                    calculateETA(); saveCalculatorState();
                });
                document.querySelector(`#leg-${legCounter} .remove-leg-btn`).addEventListener('click', removeLeg);

                // Only calculate ETA and save state if not loading from local storage initially
                if (miles === '' && destTZ === '' && destLat === '' && destLon === '') {
                    calculateETA(); // Recalculate after adding a leg manually
                    saveCalculatorState();
                }
            }

            // Function to remove a leg
            function removeLeg(event) {
                const legIdToRemove = event.target.dataset.legId;
                const legElement = document.getElementById(`leg-${legIdToRemove}`);
                if (legElement) {
                    legElement.remove();
                    // No need to decrement legCounter or re-index IDs for now,
                    // as we iterate through existing sections.
                    calculateETA();
                    saveCalculatorState(); // Save state after removing a leg
                }
            }

            // Function to perform the ETA calculation
            async function calculateETA() { // Made async to await time zone lookups
                errorMessageDiv.textContent = '';
                resultDiv.textContent = 'Calculating...';
                advancedResultDiv.textContent = 'Advanced ETA will appear here.';

                const avgSpeed = parseFloat(speedInput.value);
                const dailyDriveLimit = parseFloat(dailyDrivingLimitSelect.value);
                let current70HrClock = parseFloat(current70HourClockInput.value);
                let bufferPct = parseFloat(bufferPercentageInput.value);

                const plannedDailyBreakTotal = parseFloat(plannedDailyBreakTotalInput.value) || 1;
                const onDutyPortionOfDailyBreak = parseFloat(onDutyPortionOfDailyBreakInput.value) || 0.5;

                // Input validation for global fields
                if (isNaN(avgSpeed) || avgSpeed <= 0) {
                    errorMessageDiv.textContent = 'Please enter a valid positive number for average speed.';
                    return;
                }
                if (isNaN(dailyDriveLimit) || dailyDriveLimit <= 0) {
                    errorMessageDiv.textContent = 'Please select a valid daily driving limit or ensure logs provide a valid value.';
                    return;
                }

                // Determine current time zone (trip start)
                let tripStartTimeZone;
                if (showManualCurrentLatLonCheckbox.checked && currentLatInput.value && currentLonInput.value) {
                    const lat = parseFloat(currentLatInput.value);
                    const lon = parseFloat(currentLonInput.value);
                    tripStartTimeZone = await getTimeZoneFromCoordinates(lat, lon, currentInferredTZDisplay, 'Current Location');
                    if (!tripStartTimeZone) {
                        errorMessageDiv.textContent = 'Could not infer time zone for Current Location. Please check coordinates or select manually.';
                        resultDiv.textContent = 'Your estimated arrival time will appear here.';
                        advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                        return;
                    }
                } else {
                    tripStartTimeZone = currentTZSelect.value;
                    if (!tripStartTimeZone) {
                        errorMessageDiv.textContent = 'Please select your current time zone (Trip Start) or enable Lat/Long input.';
                        resultDiv.textContent = 'Your estimated arrival time will appear here.';
                        advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                        return;
                    }
                }

                // Default NaN to 0 for calculations
                if (isNaN(current70HrClock) || current70HrClock < 0) {
                    current70HrClock = 0;
                }
                if (isNaN(bufferPct) || bufferPct < 0) {
                    bufferPct = 0;
                }
                if (isNaN(plannedDailyBreakTotal) || plannedDailyBreakTotal < 0) {
                    errorMessageDiv.textContent = 'Please enter a valid non-negative number for Planned Daily Break.';
                    return;
                }
                if (isNaN(onDutyPortionOfDailyBreak) || onDutyPortionOfDailyBreak < 0 || onDutyPortionOfDailyBreak > plannedDailyBreakTotal) {
                    errorMessageDiv.textContent = 'Please enter a valid non-negative number for On-Duty Portion of Daily Break (must be less than or equal to total break).';
                    return;
                }


                let totalTripHours = 0;
                let cumulativeOnDutyTimeFor70Clock = current70HrClock;

                const dailyBreakTotal = plannedDailyBreakTotal;
                const dailyBreakOnDutyPortion = onDutyPortionOfDailyBreak;
                const dailyBreakOffDutyPortion = dailyBreakTotal - dailyBreakOnDutyPortion;

                const allLegsData = [];
                let totalForwardMiles = 0; // To sum up miles for round trip

                // --- Process Leg 1 (from main section) ---
                const leg1Miles = parseFloat(milesInput.value);
                let leg1DestinationTZ;

                if (showDestLatLon1Checkbox.checked && destinationLatInput.value && destinationLonInput.value) {
                    const lat = parseFloat(destinationLatInput.value);
                    const lon = parseFloat(destinationLonInput.value);
                    leg1DestinationTZ = await getTimeZoneFromCoordinates(lat, lon, leg1DestinationTZDisplay, 'Leg 1 Destination');
                    if (!leg1DestinationTZ) { // If inference failed
                        errorMessageDiv.textContent = 'Could not infer time zone for Leg 1 Destination. Please check coordinates or select manually.';
                        resultDiv.textContent = 'Your estimated arrival time will appear here.';
                        advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                        return;
                    }
                } else {
                    leg1DestinationTZ = destinationTZSelect.value;
                    if (!leg1DestinationTZ) {
                        errorMessageDiv.textContent = 'Please select a destination time zone for Leg 1 or enable Lat/Long input.';
                        resultDiv.textContent = 'Your estimated arrival time will appear here.';
                        advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                        return;
                    }
                }

                if (isNaN(leg1Miles) || leg1Miles <= 0) {
                    errorMessageDiv.textContent = 'Please enter valid positive miles for Leg 1.';
                    return;
                }

                allLegsData.push({ miles: leg1Miles, destTZ: leg1DestinationTZ });
                totalForwardMiles += leg1Miles;

                // --- Process dynamically added legs ---
                const dynamicLegSections = legsContainer.querySelectorAll('.leg-section');
                for (const legElement of dynamicLegSections) { // Use for...of for await inside loop
                    const legNumber = parseInt(legElement.id.replace('leg-', ''));
                    const miles = parseFloat(legElement.querySelector(`#miles-${legNumber}`).value);
                    const showLatLonCheckbox = legElement.querySelector(`#showDestLatLon-${legNumber}`);
                    const destLatInput = legElement.querySelector(`#destinationLat-${legNumber}`);
                    const destLonInput = legElement.querySelector(`#destinationLon-${legNumber}`);
                    const destTZSelect = legElement.querySelector(`#destinationTZ-${legNumber}`);
                    const destTZDisplay = legElement.querySelector(`#leg${legNumber}DestinationTZDisplay`);

                    let destTZ;
                    if (showLatLonCheckbox.checked && destLatInput.value && destLonInput.value) {
                        const lat = parseFloat(destLatInput.value);
                        const lon = parseFloat(destLonInput.value);
                        destTZ = await getTimeZoneFromCoordinates(lat, lon, destTZDisplay, `Leg ${legNumber} Destination`);
                        if (!destTZ) {
                            errorMessageDiv.textContent = `Could not infer time zone for Leg ${legNumber} Destination. Please check coordinates or select manually.`;
                            resultDiv.textContent = 'Your estimated arrival time will appear here.';
                            advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                            return;
                        }
                    } else {
                        destTZ = destTZSelect.value;
                        if (!destTZ) {
                            errorMessageDiv.textContent = `Please select a destination time zone for Leg ${legNumber} or enable Lat/Long input.`;
                            resultDiv.textContent = 'Your estimated arrival time will appear here.';
                            advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                            return;
                        }
                    }

                    if (isNaN(miles) || miles <= 0) {
                        errorMessageDiv.textContent = `Please enter valid positive miles for Leg ${legNumber}.`;
                        return;
                    }
                    allLegsData.push({ miles: miles, destTZ: destTZ });
                    totalForwardMiles += miles;
                }

                if (allLegsData.length === 0) { // If any validation failed, allLegsData might be empty
                    resultDiv.textContent = 'Your estimated arrival time will appear here.';
                    advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                    return;
                }

                const legSummaries = [];
                let currentTotalTripHours = 0; // This accumulates across legs for the final ETA
                let currentCumulativeOnDutyTimeFor70Clock = cumulativeOnDutyTimeFor70Clock;

                for (const legData of allLegsData) { // Use for...of for simpler iteration
                    const legNumber = allLegsData.indexOf(legData) + 1; // Get current leg number
                    const legMiles = legData.miles;
                    const legDestinationTZ = legData.destTZ;

                    const legDrivingHours = legMiles / avgSpeed;
                    const numDrivingDaysForLeg = legDrivingHours > 0 ? Math.ceil(legDrivingHours / dailyDriveLimit) : 0;

                    let legHoursAddedToTotalTrip = legDrivingHours; // Time added to total trip duration for this leg
                    let legOnDutyHoursFor70Clock = legDrivingHours; // On-duty hours for this leg for 70-clock

                    // Add daily off-duty break portion to total leg hours (always part of total trip time)
                    legHoursAddedToTotalTrip += (numDrivingDaysForLeg * dailyBreakOffDutyPortion);

                    // Add daily on-duty break portion to 70-hour clock for this leg (always counts towards 70)
                    legOnDutyHoursFor70Clock += (numDrivingDaysForLeg * dailyBreakOnDutyPortion);


                    // Apply "Extend to 14-Hour On-Duty Window" rule
                    if (apply14HourRuleCheckbox.checked) {
                        const currentOnDutyPerDrivingDay = dailyDriveLimit + dailyBreakOnDutyPortion; // Only on-duty portion of break counts towards 14-hour window
                        if (currentOnDutyPerDrivingDay < 14) {
                            const additionalOnDutyNonDrivingPerDay = 14 - currentOnDutyPerDrivingDay;
                            legHoursAddedToTotalTrip += numDrivingDaysForLeg * additionalOnDutyNonDrivingPerDay;
                            legOnDutyHoursFor70Clock += numDrivingDaysForLeg * additionalOnDutyNonDrivingPerDay;
                        }
                    }

                    // Add 10-Hour Off-Duty Breaks (between driving days within this leg)
                    if (include10HourOffDutyCheckbox.checked) {
                        const numOvernightBreaksForLeg = numDrivingDaysForLeg > 1 ? (numDrivingDaysForLeg - 1) : 0;
                        legHoursAddedToTotalTrip += numOvernightBreaksForLeg * 10;
                    }

                    // Update cumulative 70-hour clock
                    currentCumulativeOnDutyTimeFor70Clock += legOnDutyHoursFor70Clock;

                    // Consider 70-Hour Clock & 34-Hour Reset (applied cumulatively across legs)
                    if (consider70HourClockCheckbox.checked) {
                        const num70HourBlocks = Math.floor(currentCumulativeOnDutyTimeFor70Clock / 70);
                        if (num70HourBlocks > 0) {
                            legHoursAddedToTotalTrip += num70HourBlocks * 34; // Add 34-hour reset time to this leg's total
                            currentCumulativeOnDutyTimeFor70Clock -= (num70HourBlocks * 70);
                        }
                    }

                    currentTotalTripHours += legHoursAddedToTotalTrip;

                    // Calculate arrival time for this specific leg's destination
                    const tripStartTime = new Date(); // Reference for the entire trip
                    const legArrivalTimeMs = tripStartTime.getTime() + (currentTotalTripHours * 60 * 60 * 1000);
                    const legArrivalDate = new Date(legArrivalTimeMs);

                    const legFormatter = new Intl.DateTimeFormat('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: 'numeric', minute: 'numeric', timeZoneName: 'short',
                        timeZone: legDestinationTZ, // Convert to this leg's destination TZ
                        hour12: true
                    });
                    const formattedLegArrival = legFormatter.format(legArrivalDate);

                    legSummaries.push(`Leg ${legNumber} (to ${legDestinationTZ}): Arrives ${formattedLegArrival}`);

                    // The currentLegOriginTZ is implicitly handled by using the previous leg's destTZ for the next leg's calculation
                }

                // --- Add Round Trip Leg if enabled ---
                if (enableRoundTripCheckbox.checked) {
                    const returnMiles = totalForwardMiles; // Total miles for the return trip
                    // For the return trip, the destination is the original starting time zone
                    const returnDestinationTZ = tripStartTimeZone; // Use the determined trip start TZ

                    if (!returnDestinationTZ) { // Should not happen if tripStartTimeZone was determined
                         errorMessageDiv.textContent = 'Could not determine return trip destination time zone.';
                         resultDiv.textContent = 'Your estimated arrival time will appear here.';
                         advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                        return;
                    }

                    const returnDrivingHours = returnMiles / avgSpeed;
                    const numDrivingDaysForReturnLeg = returnDrivingHours > 0 ? Math.ceil(returnDrivingHours / dailyDriveLimit) : 0;

                    let returnLegHoursAddedToTotalTrip = returnDrivingHours;
                    let returnLegOnDutyHoursFor70Clock = returnDrivingHours;

                    returnLegHoursAddedToTotalTrip += (numDrivingDaysForReturnLeg * dailyBreakOffDutyPortion);
                    returnLegOnDutyHoursFor70Clock += (numDrivingDaysForReturnLeg * dailyBreakOnDutyPortion);

                    if (apply14HourRuleCheckbox.checked) {
                        const currentOnDutyPerDrivingDay = dailyDriveLimit + dailyBreakOnDutyPortion;
                        if (currentOnDutyPerDrivingDay < 14) {
                            const additionalOnDutyNonDrivingPerDay = 14 - currentOnDutyPerDrivingDay;
                            returnLegHoursAddedToTotalTrip += numDrivingDaysForReturnLeg * additionalOnDutyNonDrivingPerDay;
                            returnLegOnDutyHoursFor70Clock += numDrivingDaysForReturnLeg * additionalOnDutyNonDrivingPerDay;
                        }
                    }

                    if (include10HourOffDutyCheckbox.checked) {
                        const numOvernightBreaksForReturnLeg = numDrivingDaysForReturnLeg > 1 ? (numDrivingDaysForReturnLeg - 1) : 0;
                        returnLegHoursAddedToTotalTrip += numOvernightBreaksForReturnLeg * 10;
                    }

                    currentCumulativeOnDutyTimeFor70Clock += returnLegOnDutyHoursFor70Clock;

                    if (consider70HourClockCheckbox.checked) {
                        const num70HourBlocks = Math.floor(currentCumulativeOnDutyTimeFor70Clock / 70);
                        if (num70HourBlocks > 0) {
                            currentTotalTripHours += num70HourBlocks * 34; // Add 34-hour reset time to this leg's total
                            currentCumulativeOnDutyTimeFor70Clock -= (num70HourBlocks * 70);
                        }
                    }

                    currentTotalTripHours += returnLegHoursAddedToTotalTrip;

                    const tripStartTime = new Date();
                    const returnArrivalTimeMs = tripStartTime.getTime() + (currentTotalTripHours * 60 * 60 * 1000);
                    const returnArrivalDate = new Date(returnArrivalTimeMs);

                    const returnFormatter = new Intl.DateTimeFormat('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: 'numeric', minute: 'numeric', timeZoneName: 'short',
                        timeZone: returnDestinationTZ,
                        hour12: true
                    });
                    const formattedReturnArrival = returnFormatter.format(returnArrivalDate);
                    legSummaries.push(`Return Trip (to ${returnDestinationTZ}): Arrives ${formattedReturnArrival}`);
                }


                // Apply Additional Buffer for Delays to the *final* total trip hours
                if (bufferPct > 0) {
                    currentTotalTripHours *= (1 + bufferPct / 100);
                }

                const tripStartTime = new Date(); // Re-get current time for final calculation
                const finalArrivalTimeMs = tripStartTime.getTime() + (currentTotalTripHours * 60 * 60 * 1000);
                const finalArrivalDate = new Date(finalArrivalTimeMs);
                const finalFormatter = new Intl.DateTimeFormat('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: 'numeric', minute: 'numeric', timeZoneName: 'short',
                    timeZone: enableRoundTripCheckbox.checked ? tripStartTimeZone : allLegsData[allLegsData.length - 1].destTZ, // Final destination TZ of the last leg or original start TZ if round trip
                    hour12: true
                });
                const formattedFinalArrival = finalFormatter.format(finalArrivalDate);

                // Display results
                resultDiv.textContent = `Estimated Total Trip Arrival: ${formattedFinalArrival}`;
                advancedResultDiv.innerHTML = `<h3>Trip Summary:</h3>` + legSummaries.join('<br>') + `<br><br><strong>Overall Estimated Arrival: ${formattedFinalArrival}</strong>`;
            }

            // Function to reset all inputs and results
            function resetCalculator() {
                milesInput.value = ''; // Reset Leg 1 miles
                speedInput.value = '';
                dailyDrivingLimitSelect.value = '11'; // Reset to default 11 hours
                populateTimeZones(currentTZSelect); // Re-populate current time zone
                populateTimeZones(destinationTZSelect); // Re-populate destination time zone
                destinationTZSelect.value = ''; // Reset to default "Select time zone..."

                // Reset manual current Lat/Lon inputs and hide div
                showManualCurrentLatLonCheckbox.checked = false;
                manualCurrentLatLonOptionsDiv.classList.add('hidden');
                manualCurrentLatLonOptionsDiv.classList.remove('block');
                currentLatInput.value = '';
                currentLonInput.value = '';
                currentInferredTZDisplay.textContent = '';

                // Reset destination Lat/Lon inputs and hide div
                showDestLatLon1Checkbox.checked = false;
                leg1DestLatLonOptionsDiv.classList.add('hidden');
                leg1DestLatLonOptionsDiv.classList.remove('block');
                destinationLatInput.value = ''; // Reset Lat for Leg 1
                destinationLonInput.value = ''; // Reset Lon for Leg 1
                leg1DestinationTZDisplay.textContent = ''; // Clear display


                plannedDailyBreakTotalInput.value = '1'; // Reset new inputs
                onDutyPortionOfDailyBreakInput.value = '0.5'; // Reset new inputs
                current70HourClockInput.value = ''; // Clear to show placeholder
                bufferPercentageInput.value = ''; // Clear to show placeholder
                apply14HourRuleCheckbox.checked = false;
                include10HourOffDutyCheckbox.checked = false;
                consider70HourClockCheckbox.checked = false;
                enableRoundTripCheckbox.checked = false; // Reset Round Trip checkbox
                linkLogsToCalculatorCheckbox.checked = false; // Reset log linking checkbox
                dailyDrivingLimitSelect.disabled = false; // Make editable again
                dailyDrivingLimitSelect.readOnly = false;
                current70HourClockInput.disabled = false; // Make 70-hour input editable again
                current70HourClockInput.readOnly = false;
                // Re-enable options for dailyDrivingLimitSelect
                Array.from(dailyDrivingLimitSelect.options).forEach(option => {
                    option.disabled = false;
                });


                resultDiv.textContent = 'Your estimated arrival time will appear here.';
                advancedResultDiv.textContent = 'Advanced ETA will appear here.';
                errorMessageDiv.textContent = '';
                currentLocationDisplay.textContent = ''; // Clear GPS location display

                // Clear all dynamically added legs
                legsContainer.innerHTML = '';
                legCounter = 1; // Reset leg counter for next additions

                // Clear log sheet form and data
                startTimeInput.value = '';
                endTimeInput.value = '';
                dutyStatusSelect.value = '';
                logRemarksInput.value = '';
                currentDayLogs = [];
                renderLogEntries();
                calculateDailySummary();
                logDateInput.value = formatDateForFirestore(new Date()); // Reset log date to today

                // Hide all collapsible sections by default on reset
                advancedOptionsDiv.classList.add('hidden');
                toggleAdvancedBtn.textContent = 'Show Advanced HOS Options';
                chainingOptionsDiv.classList.add('hidden');
                toggleChainingBtn.textContent = 'Show Destination Chaining Options';
                logSheetSection.classList.add('hidden');
                toggleLogSheetBtn.textContent = 'Show Log Sheet Tracker';
                commentsSectionContent.classList.add('hidden'); // Hide comments section
                showCommentsBtn.textContent = 'The Comments Section'; // Reset button text
                announcementsSectionContent.classList.add('hidden'); // Hide announcements section
                toggleAnnouncementsBtn.textContent = 'Show Announcements'; // Reset button text

                saveCalculatorState(); // Save the reset state
                calculateETA(); // Recalculate after reset
            }


            // Event Listeners for global inputs (Leg 1)
            milesInput.addEventListener('input', () => { calculateETA(); saveCalculatorState(); });
            speedInput.addEventListener('input', () => { calculateETA(); saveCalculatorState(); });
            dailyDrivingLimitSelect.addEventListener('change', () => { calculateETA(); saveCalculatorState(); }); // Still listen for manual changes if not linked
            currentTZSelect.addEventListener('change', () => { calculateETA(); saveCalculatorState(); });
            destinationTZSelect.addEventListener('change', () => { calculateETA(); saveCalculatorState(); }); // Listen for new destination TZ select

            // Event Listeners for new granular break inputs
            plannedDailyBreakTotalInput.addEventListener('input', () => { calculateETA(); saveCalculatorState(); });
            onDutyPortionOfDailyBreakInput.addEventListener('input', () => { calculateETA(); saveCalculatorState(); });

            // Event Listeners for buttons
            calculateBtn.addEventListener('click', calculateETA);
            resetBtn.addEventListener('click', resetCalculator);

            // Event Listeners for toggles
            toggleAdvancedBtn.addEventListener('click', () => {
                advancedOptionsDiv.classList.toggle('hidden');
                advancedOptionsDiv.classList.toggle('block');
                if (advancedOptionsDiv.classList.contains('block')) {
                    toggleAdvancedBtn.textContent = 'Hide Advanced HOS Options';
                } else {
                    toggleAdvancedBtn.textContent = 'Show Advanced HOS Options';
                }
                // Only recalculate if advanced options are now visible OR if they were just hidden and we need to update the basic result
                calculateETA();
                saveCalculatorState(); // Save state of toggle
            });

            toggleChainingBtn.addEventListener('click', () => {
                chainingOptionsDiv.classList.toggle('hidden');
                chainingOptionsDiv.classList.toggle('block');
                if (chainingOptionsDiv.classList.contains('block')) {
                    toggleChainingBtn.textContent = 'Hide Destination Chaining Options';
                } else {
                    toggleChainingBtn.textContent = 'Show Destination Chaining Options';
                }
                calculateETA(); // Recalculate when visibility changes
                saveCalculatorState(); // Save state of toggle
            });

            toggleLogSheetBtn.addEventListener('click', () => {
                logSheetSection.classList.toggle('hidden');
                logSheetSection.classList.toggle('block');
                if (logSheetSection.classList.contains('block')) {
                    toggleLogSheetBtn.textContent = 'Hide Log Sheet Tracker';
                    loadLogsForSelectedDate(); // Load logs when section is opened
                } else {
                    toggleLogSheetBtn.textContent = 'Show Log Sheet Tracker';
                }
                saveCalculatorState(); // Save state of toggle
            });

            // Event Listeners for dynamic leg management
            addLegBtn.addEventListener('click', addLeg);
            legsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-leg-btn')) {
                    removeLeg(event);
                }
            });

            // Event listeners for advanced HOS options
            apply14HourRuleCheckbox.addEventListener('change', () => { calculateETA(); saveCalculatorState(); });
            include10HourOffDutyCheckbox.addEventListener('change', () => { calculateETA(); saveCalculatorState(); });
            consider70HourClockCheckbox.addEventListener('change', () => { calculateETA(); saveCalculatorState(); });
            current70HourClockInput.addEventListener('input', () => {
                // Only trigger ETA and save if not linked, otherwise updateHOSFromLogs handles it
                if (!linkLogsToCalculatorCheckbox.checked) {
                    calculateETA();
                    saveCalculatorState();
                }
            });
            bufferPercentageInput.addEventListener('input', () => { calculateETA(); saveCalculatorState(); });
            enableRoundTripCheckbox.addEventListener('change', () => { calculateETA(); saveCalculatorState(); });

            // --- Comment Section Toggle (now inline) ---
            showCommentsBtn.addEventListener('click', () => {
                commentsSectionContent.classList.toggle('hidden');
                commentsSectionContent.classList.toggle('block');
                if (commentsSectionContent.classList.contains('block')) {
                    showCommentsBtn.textContent = 'Hide Comments Section';
                    // When comments section is revealed, ensure comments are loaded/refreshed
                    listenForComments();
                } else {
                    showCommentsBtn.textContent = 'The Comments Section';
                }
                saveCalculatorState(); // Save state of toggle
            });

            // Firestore collection reference for comments
            const commentsCollectionRef = collection(db, `artifacts/${appId}/public/comments`);
            // Firestore collection reference for user-specific hidden comments
            const getHiddenCommentsCollectionRef = (userId) => collection(db, `artifacts/${appId}/users/${userId}/hiddenComments`);

            let hiddenCommentIds = new Set(); // Store IDs of comments hidden by the current user

            // Function to load hidden comments for the current user
            async function loadHiddenComments() {
                const currentUserId = getFirebaseUserId();
                if (!currentUserId || !db || !getIsAuthReady()) {
                    console.warn("User not authenticated or Firestore not ready. Cannot load hidden comments.");
                    hiddenCommentIds.clear(); // Clear any previous hidden comments
                    return;
                }

                try {
                    const hiddenCommentsSnapshot = await getDocs(getHiddenCommentsCollectionRef(currentUserId));
                    hiddenCommentIds.clear(); // Clear previous state
                    hiddenCommentsSnapshot.forEach(doc => {
                        hiddenCommentIds.add(doc.id); // Doc ID is the comment ID
                    });
                    console.log("Hidden comments loaded for current user.");
                } catch (e) {
                    console.error("Error loading hidden comments:", e);
                    errorMessageDiv.textContent = "Error loading your hidden comments.";
                }
            }

            // Function to listen for real-time comments
            async function listenForComments() {
                if (!db || !getIsAuthReady()) {
                    console.warn("Firestore not ready for comments. Retrying...");
                    return;
                }

                // Load hidden comments first, then listen for public comments
                await loadHiddenComments();

                // Order by timestamp descending, limit to a reasonable number of recent comments
                const q = query(commentsCollectionRef, orderBy("timestamp", "desc"));

                onSnapshot(q, (snapshot) => {
                    commentsDisplayArea.innerHTML = ''; // Clear previous comments
                    if (snapshot.empty) {
                        commentsDisplayArea.innerHTML = '<p class="text-center text-gray-500">No comments yet. Be the first!</p>';
                        return;
                    }
                    snapshot.forEach((doc) => {
                        const commentData = doc.data();
                        const commentId = doc.id; // Get the document ID for deletion

                        // Skip rendering if this comment is in the current user's hidden list
                        if (hiddenCommentIds.has(commentId)) {
                            return;
                        }

                        const commentEntry = document.createElement('div');
                        commentEntry.classList.add('comment-entry');

                        const timestamp = commentData.timestamp ? new Date(commentData.timestamp.toDate()).toLocaleString() : 'N/A';
                        const userIdDisplay = commentData.userId || 'Anonymous'; // Fallback for anonymous

                        commentEntry.innerHTML = `
                            <strong>User ID: ${userIdDisplay}</strong>
                            <span class="timestamp">${timestamp}</span>
                            <p>${commentData.commentText}</p>
                        `;

                        // Add Hide button for all users
                        const hideBtn = document.createElement('button');
                        hideBtn.classList.add('hide-comment-btn');
                        hideBtn.textContent = 'Hide';
                        hideBtn.dataset.commentId = commentId; // Store comment ID for hiding
                        commentEntry.appendChild(hideBtn);

                        // Add delete button only if current user is the ADMIN_UID
                        if (getFirebaseUserId() === getAdminUID() && getAdminUID() !== 'YOUR_ADMIN_FIREBASE_UID_HERE') { // Also check if ADMIN_UID is not the placeholder
                            const deleteBtn = document.createElement('button');
                            deleteBtn.classList.add('delete-comment-btn');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.dataset.commentId = commentId; // Store comment ID for deletion
                            commentEntry.appendChild(deleteBtn);
                        }
                        commentsDisplayArea.appendChild(commentEntry);
                    });
                }, (error) => {
                    console.error("Error listening to comments:", error);
                    commentsDisplayArea.innerHTML = '<p class="text-red-500 text-center">Error loading comments.</p>';
                });
            }

            // Function for user to hide a comment from their view
            async function hideComment(commentId) {
                const currentUserId = getFirebaseUserId();
                if (!currentUserId || !db || !getIsAuthReady()) {
                    errorMessageDiv.textContent = "Authentication not ready. Cannot hide comment.";
                    return;
                }

                try {
                    // Add the comment ID to the user's hiddenComments subcollection
                    const hideDocRef = doc(getHiddenCommentsCollectionRef(currentUserId), commentId);
                    await setDoc(hideDocRef, { hiddenAt: serverTimestamp() });
                    hiddenCommentIds.add(commentId); // Add to local set immediately
                    console.log(`Comment ${commentId} hidden for user ${currentUserId}.`);
                    errorMessageDiv.textContent = ''; // Clear any previous error
                    // Re-render comments to reflect the change
                    listenForComments(); // This will re-fetch and filter
                } catch (e) {
                    console.error("Error hiding comment:", e);
                    errorMessageDiv.textContent = "Error hiding comment. Please try again.";
                }
            }


            // Function to delete a comment (Admin only)
            async function deleteComment(commentId) {
                const currentUserId = getFirebaseUserId();
                const adminUid = getAdminUID();

                if (!currentUserId || currentUserId !== adminUid || adminUid === 'YOUR_ADMIN_FIREBASE_UID_HERE') {
                    errorMessageDiv.textContent = "You do not have permission to delete comments.";
                    console.warn("Attempted delete by non-admin or placeholder admin UID.");
                    return;
                }

                // Using a custom modal for confirmation instead of window.confirm
                showCustomConfirm("Are you sure you want to delete this comment? This action cannot be undone.", async () => {
                    try {
                        const commentDocRef = doc(db, `artifacts/${appId}/public/comments`, commentId);
                        await deleteDoc(commentDocRef);
                        console.log("Comment deleted successfully:", commentId);
                        errorMessageDiv.textContent = ''; // Clear any previous error
                        // No need to explicitly remove from hiddenCommentIds here, as listenForComments() will re-render
                    } catch (e) {
                        console.error("Error deleting comment:", e);
                        errorMessageDiv.textContent = "Error deleting comment. Please try again.";
                    }
                });
            }

            // Function to show a custom confirmation modal
            function showCustomConfirm(message, onConfirm) {
                const confirmModalHtml = `
                    <div id="customConfirmModal" class="comment-modal-overlay">
                        <div class="comment-modal-content">
                            <h2 class="text-xl font-semibold mb-4">${message}</h2>
                            <div class="flex justify-center gap-4">
                                <button id="confirmYesBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl">Yes, Delete</button>
                                <button id="confirmNoBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl">No, Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', confirmModalHtml);

                const customConfirmModal = document.getElementById('customConfirmModal');
                document.getElementById('confirmYesBtn').addEventListener('click', () => {
                    onConfirm();
                    customConfirmModal.remove();
                });
                document.getElementById('confirmNoBtn').addEventListener('click', () => {
                    customConfirmModal.remove();
                });
            }


            // Event listener for comment submission
            submitCommentBtn.addEventListener('click', async () => {
                const commentText = commentInput.value.trim();
                const currentUserId = getFirebaseUserId();

                if (!commentText) {
                    errorMessageDiv.textContent = "Comment cannot be empty.";
                    return;
                }
                if (!currentUserId) {
                    errorMessageDiv.textContent = "Authentication failed. Cannot submit comment.";
                    return;
                }

                try {
                    await addDoc(commentsCollectionRef, {
                        userId: currentUserId,
                        commentText: commentText,
                        timestamp: serverTimestamp() // Firestore server timestamp
                    });
                    commentInput.value = ''; // Clear input
                    errorMessageDiv.textContent = ''; // Clear any previous error
                    console.log("Comment submitted successfully.");
                } catch (e) {
                    console.error("Error adding comment:", e);
                    errorMessageDiv.textContent = "Error submitting comment. Please try again.";
                }
            });

            // Event delegation for delete and hide buttons within commentsDisplayArea
            commentsDisplayArea.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-comment-btn')) {
                    const commentId = event.target.dataset.commentId;
                    deleteComment(commentId);
                } else if (event.target.classList.contains('hide-comment-btn')) {
                    const commentId = event.target.dataset.commentId;
                    hideComment(commentId);
                }
            });

            // --- Announcement Section Logic (New) ---
            const announcementsCollectionRef = collection(db, `artifacts/${appId}/public/announcements`);

            // Function to save an announcement (Admin only)
            saveAnnouncementBtn.addEventListener('click', async () => {
                const announcementText = announcementInput.value.trim();
                const currentUserId = getFirebaseUserId();
                const adminUid = getAdminUID();

                if (!announcementText) {
                    errorMessageDiv.textContent = "Announcement cannot be empty.";
                    return;
                }
                if (!currentUserId || currentUserId !== adminUid || adminUid === 'YOUR_ADMIN_FIREBASE_UID_HERE') {
                    errorMessageDiv.textContent = "You do not have permission to post announcements.";
                    console.warn("Attempted announcement post by non-admin or placeholder admin UID.");
                    return;
                }

                try {
                    await addDoc(announcementsCollectionRef, {
                        userId: currentUserId, // Store admin's UID
                        announcementText: announcementText,
                        timestamp: serverTimestamp()
                    });
                    announcementInput.value = ''; // Clear input
                    errorMessageDiv.textContent = '';
                    console.log("Announcement posted successfully.");
                } catch (e) {
                    console.error("Error posting announcement:", e);
                    errorMessageDiv.textContent = "Error posting announcement. Please try again.";
                }
            });

            // Function to listen for real-time announcements
            async function listenForAnnouncements() {
                if (!db || !getIsAuthReady()) {
                    console.warn("Firestore not ready for announcements. Retrying...");
                    return;
                }

                // Show/hide admin input based on user's UID
                if (getFirebaseUserId() === getAdminUID() && getAdminUID() !== 'YOUR_ADMIN_FIREBASE_UID_HERE') {
                    adminAnnouncementInputDiv.classList.remove('hidden');
                } else {
                    adminAnnouncementInputDiv.classList.add('hidden');
                }

                const q = query(announcementsCollectionRef, orderBy("timestamp", "desc"));

                onSnapshot(q, (snapshot) => {
                    announcementsDisplayArea.innerHTML = ''; // Clear previous announcements
                    if (snapshot.empty) {
                        announcementsDisplayArea.innerHTML = '<p class="text-center text-gray-500">No announcements yet.</p>';
                        return;
                    }
                    snapshot.forEach((doc) => {
                        const announcementData = doc.data();
                        const announcementId = doc.id;

                        const announcementEntry = document.createElement('div');
                        announcementEntry.classList.add('announcement-entry');

                        const timestamp = announcementData.timestamp ? new Date(announcementData.timestamp.toDate()).toLocaleString() : 'N/A';
                        const userIdDisplay = announcementData.userId || 'Admin'; // Should always be Admin if posted correctly

                        announcementEntry.innerHTML = `
                            <strong>Posted by: ${userIdDisplay}</strong>
                            <span class="timestamp">${timestamp}</span>
                            <p>${announcementData.announcementText}</p>
                        `;

                        // Add delete button only if current user is the ADMIN_UID
                        if (getFirebaseUserId() === getAdminUID() && getAdminUID() !== 'YOUR_ADMIN_FIREBASE_UID_HERE') {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.classList.add('delete-announcement-btn');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.dataset.announcementId = announcementId;
                            announcementEntry.appendChild(deleteBtn);
                        }
                        announcementsDisplayArea.appendChild(announcementEntry);
                    });
                }, (error) => {
                    console.error("Error listening to announcements:", error);
                    announcementsDisplayArea.innerHTML = '<p class="text-red-500 text-center">Error loading announcements.</p>';
                });
            }

            // Event delegation for delete buttons within announcementsDisplayArea
            announcementsDisplayArea.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-announcement-btn')) {
                    const announcementId = event.target.dataset.announcementId;
                    // Using a custom modal for confirmation instead of window.confirm
                    showCustomConfirm("Are you sure you want to delete this announcement? This action cannot be undone.", async () => {
                        const currentUserId = getFirebaseUserId();
                        const adminUid = getAdminUID();

                        if (!currentUserId || currentUserId !== adminUid || adminUid === 'YOUR_ADMIN_FIREBASE_UID_HERE') {
                            errorMessageDiv.textContent = "You do not have permission to delete announcements.";
                            console.warn("Attempted announcement delete by non-admin or placeholder admin UID.");
                            return;
                        }
                        try {
                            const announcementDocRef = doc(db, `artifacts/${appId}/public/announcements`, announcementId);
                            await deleteDoc(announcementDocRef);
                            console.log("Announcement deleted successfully:", announcementId);
                            errorMessageDiv.textContent = '';
                        } catch (e) {
                            console.error("Error deleting announcement:", e);
                            errorMessageDiv.textContent = "Error deleting announcement. Please try again.";
                        }
                    });
                }
            });


            // --- Branding Static Image Setup ---
            // Instructions for user:
            // 1. Upload your truck logo image (e.g., truck_logo.png) to your GitHub repository.
            //    A good place might be a new folder like 'images' in your repo's root.
            // 2. Get the direct URL to that image. On GitHub, navigate to the image file,
            //    then right-click on the image itself and select "Copy image address".
            // 3. Replace 'YOUR_TRUCK_LOGO_IMAGE_URL_HERE' below with that copied URL.

            // 4. Generate your QR code image (e.g., qr_code.png) that links to your live calculator:
            //    https://cyraunyielding.github.io/Trucker-ETA-Calculator/
            //    You can use an online QR code generator for this.
            // 5. Upload this QR code image to your GitHub repository (e.g., in the 'images' folder).
            // 6. Get the direct URL to that QR code image.
            // 7. Replace 'YOUR_QR_CODE_IMAGE_URL_HERE' below with that copied URL.

            // Example of how to set the URLs:
            // truckLogo.src = "https://raw.githubusercontent.com/cyraunyielding/Trucker-ETA-Calculator/main/images/truck_logo.png";
            // qrCodeImage.src = "https://raw.githubusercontent.com/cyraunyielding/Trucker-ETA-Calculator/main/images/qr_code.png";

            // Placeholder URLs for now - YOU NEED TO REPLACE THESE!
            truckLogo.src = "https://placehold.co/150x100/e0f4f8/2c3e50?text=Upload+Logo";
            // QR Code Image URL generated for https://cyraunyielding.github.io/Trucker-ETA-Calculator/
            qrCodeImage.src = "https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://cyraunyielding.github.io/Trucker-ETA-Calculator/";
            <!-- theBacchanalian -->
            // Set GitHub Link (already correct)
            githubLink.href = "https://github.com/cyraunyielding";
            // Set Issues Link (already correct)
            issuesLink.href = "https://github.com/cyraunyielding/Trucker-ETA-Calculator/issues";

            // Load state from local storage first
            await loadCalculatorState(); // Await this to ensure state is loaded before initial ETA calculation

            // Initial calculation when page loads (after loading state)
            calculateETA();

            // Load logs for the current date after Firebase authentication is ready
            // The onAuthStateChanged listener at the top of the script will call loadLogsForSelectedDate()
            // once authentication is complete.
        });

        // PayPal button rendering (Code 2) - Moved to window.onload for better compatibility
        // This ensures the PayPal SDK is fully loaded and ready before attempting to render the button.
        window.onload = function () {
            if (typeof paypal !== 'undefined' && paypal.HostedButtons) {
                paypal.HostedButtons({
                    hostedButtonId: "JSEAH3HWUE9VG",
                }).render("#paypal-container-JSEAH3HWUE9VG");
                console.log("PayPal button render attempt successful.");
            } else {
                console.warn("PayPal SDK not loaded or HostedButtons component not available on window.onload.");
                const paypalContainer = document.getElementById('paypal-container-JSEAH3HWUE9VG');
                if (paypalContainer) {
                    paypalContainer.innerHTML = '<p class="text-red-500 text-sm">PayPal button could not load. Please try refreshing the page or check your internet connection.</p>';
                }
            }
        };
    </script>
</body>
</html>
